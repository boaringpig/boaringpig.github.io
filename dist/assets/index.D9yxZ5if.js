!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const n of t)if("childList"===n.type)for(const t of n.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}(),window.supabaseConfig={supabaseUrl:"https://ntbgccxxdhtlysjxtsou.supabase.co",supabaseAnonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50YmdjY3h4ZGh0bHlzanh0c291Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4Mjg3MjYsImV4cCI6MjA2OTQwNDcyNn0.G-aOH8wGVY-Fo8_NI3giydakYnh1MR18-e78wF39OG8"},window.spiral=function(){let t,e,n=[],i=!1,o=null,a=0,s=null,r=null,d=[],c=0,l=null,w="#ffffff";function u(){o&&(cancelAnimationFrame(o),o=null)}function p(){if(t){const e=t.parentElement;t.width=e.clientWidth,t.height=e.clientHeight,n.forEach(e=>{e.x=t.width/2,e.y=t.height/2})}}function m(i){const a=i;o=requestAnimationFrame(m);const s=document.getElementById("bg-color").value;e.fillStyle=s,e.fillRect(0,0,t.width,t.height),n.forEach(t=>{t.draw(a)})}class v{constructor(e,n={}){this.id=e,this.speed=n.speed||1,this.radiusPercent=n.radiusPercent||50,this.arms=n.arms||3,this.thickness=n.thickness||3,this.color=n.color||"#4fc3f7",this.opacity=n.opacity||.8,this.timeOffset=n.timeOffset||0,this.rotation=n.rotation||0,this.x=t.width/2,this.y=t.height/2}get radius(){const e=Math.min(t.width,t.height);return this.radiusPercent/100*e*2}draw(t){const n=(t+1e3*this.timeOffset)*this.speed*.001;e.save(),e.translate(this.x,this.y),e.rotate(this.rotation*Math.PI/180+.5*n),e.strokeStyle=this.color,e.lineWidth=this.thickness,e.globalAlpha=this.opacity,e.lineCap="round",e.lineJoin="round";for(let i=0;i<this.arms;i++){e.save(),e.rotate(2*i*Math.PI/this.arms),e.beginPath();let t=!0;for(let i=0;i<this.radius;i+=.5){const o=.08*i+n,a=i*Math.cos(o),s=i*Math.sin(o);t?(e.moveTo(a,s),t=!1):e.lineTo(a,s)}e.stroke(),e.restore()}e.restore()}}function g(){const t=new v(n.length,{radiusPercent:50,arms:3,thickness:3,color:"#4fc3f7",opacity:.8,speed:1,timeOffset:0,rotation:0});n.push(t),a=n.length-1,y(),k(t)}function h(){n=[],a=-1,y(),f()}function y(){const t=document.getElementById("spiral-list");t&&(t.innerHTML="",n.forEach((e,n)=>{const i=document.createElement("div");i.className="spiral-list-item "+(n===a?"active":""),i.innerHTML=`\n\t\t\t\t\t<span>Spiral ${n+1}</span>\n\t\t\t\t\t<div class="actions">\n\t\t\t\t\t\t<button onclick="window.spiral.selectSpiral(${n})" class="action-btn check-btn">Edit</button>\n\t\t\t\t\t\t<button onclick="window.spiral.deleteSpiral(${n})" class="action-btn delete-btn">Delete</button>\n\t\t\t\t\t</div>\n\t\t\t\t`,t.appendChild(i)}))}function f(){["speed","radius","arms","thickness","color","opacity","time-offset","rotation"].forEach(t=>{const e=document.getElementById(t);e&&(e.value=e.min)}),document.getElementById("color").value="#000000"}function k(t){document.getElementById("speed").value=t.speed,document.getElementById("radius").value=t.radiusPercent,document.getElementById("arms").value=t.arms,document.getElementById("thickness").value=t.thickness,document.getElementById("color").value=t.color,document.getElementById("opacity").value=t.opacity,document.getElementById("time-offset").value=t.timeOffset,document.getElementById("rotation").value=t.rotation,b()}function b(){["speed","radius","arms","thickness","color","opacity","time-offset","rotation"].forEach(t=>{const e=document.getElementById(t),n=document.getElementById(`${t}-val`);if(e&&n){let i=e.value;"radius"===t&&(i+="%"),"rotation"===t&&(i+="°"),"speed"!==t&&"opacity"!==t&&"time-offset"!==t||(i=parseFloat(i).toFixed(1)),n.textContent=i}}),document.getElementById("text-interval-val").textContent=document.getElementById("text-interval").value+"ms",document.getElementById("text-hold-val").textContent=document.getElementById("text-hold").value+"ms",document.getElementById("text-anim-speed-val").textContent=parseFloat(document.getElementById("text-anim-speed").value).toFixed(1)+"s",document.getElementById("text-size-val").textContent=parseFloat(document.getElementById("text-size").value).toFixed(1)+"rem"}function T(){i=!1,l&&clearTimeout(l),S()}function I(){if(!i)return void S();c>=d.length&&(c=0);const t=d[c];if("text"===t.type){setTimeout(()=>{!function(t){s.style.transition="none",s.style.transform="translate(-50%, -50%) scale(0)",s.style.opacity="0",s.textContent=t,s.style.fontSize="2.5rem",s.style.color=w,s.style.transformOrigin="center center",s.offsetHeight,s.style.transition="opacity 0.5s ease-out, transform 0.5s ease-out",s.style.opacity="1",s.style.transform="translate(-50%, -50%) scale(1)";const e=parseInt(document.getElementById("text-hold").value);setTimeout(()=>{i&&S()},500+e)}(t.value)},50),c++,parseInt(document.getElementById("text-interval").value);const e=parseInt(document.getElementById("text-hold").value),n=500;l=setTimeout(I,n+e+n+50)}else"delay"===t.type&&(S(),c++,l=setTimeout(I,t.value))}function S(){s.style.transition="opacity 0.5s ease-out, transform 0.5s ease-out",s.style.opacity="0",s.style.transform="translate(-50%, -50%) scale(2)"}function C(){r&&(r.value="Welcome to the Spiral Generator\nDELAY:2000\nWatch the patterns dance\nDELAY:1500\nCustomize every parameter\nDELAY:2000\nCreate your own visual symphony\nDELAY:3000\nThe possibilities are infinite"),s&&(s.textContent="Start the text loop!",s.style.color=document.getElementById("text-color").value,s.style.fontSize=document.getElementById("text-size").value+"rem")}function D(){return{spirals:n.map(t=>({id:t.id,speed:t.speed,radiusPercent:t.radiusPercent,arms:t.arms,thickness:t.thickness,color:t.color,opacity:t.opacity,timeOffset:t.timeOffset,rotation:t.rotation})),textSettings:{script:r.value,interval:document.getElementById("text-interval").value,holdDuration:document.getElementById("text-hold").value,animationSpeed:document.getElementById("text-anim-speed").value,size:document.getElementById("text-size").value,color:document.getElementById("text-color").value},globalSettings:{backgroundColor:document.getElementById("bg-color").value,selectedSpiralIndex:a}}}function B(i){var o;i&&(h(),i.spirals&&Array.isArray(i.spirals)&&(i.spirals.forEach(t=>{const e=new v(t.id,t);n.push(e)}),y(),n.length>0&&(a=o=0,y(),k(n[o]))),i.textSettings&&(r&&(r.value=i.textSettings.script||""),document.getElementById("text-interval")&&(document.getElementById("text-interval").value=i.textSettings.interval||2e3),document.getElementById("text-hold")&&(document.getElementById("text-hold").value=i.textSettings.holdDuration||3e3),document.getElementById("text-anim-speed")&&(document.getElementById("text-anim-speed").value=i.textSettings.animationSpeed||.5),document.getElementById("text-size")&&(document.getElementById("text-size").value=i.textSettings.size||2.5),document.getElementById("text-color")&&(document.getElementById("text-color").value=i.textSettings.color||"#ffffff"),b()),i.globalSettings&&(document.getElementById("bg-color").value=i.globalSettings.backgroundColor||"#000000",e.fillStyle=document.getElementById("bg-color").value,e.fillRect(0,0,t.width,t.height)))}return window.showSpiralTaskConfigModal=function(t){const e=document.createElement("div");e.className="modal-overlay",e.innerHTML='\n\t\t\t<div class="modal-content">\n\t\t\t\t<h3>🌀 Create Spiral Task</h3>\n\t\t\t\t<p>Configure the task settings for this spiral:</p>\n\t\t\t\t\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label class="form-label">Task Description</label>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\tid="spiralTaskDescription" \n\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\tvalue="Experience the Spiral Animation" \n\t\t\t\t\t\tplaceholder="Enter task description..."\n\t\t\t\t\t\tmaxlength="200"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="form-row">\n\t\t\t\t\t<div class="form-group">\n\t\t\t\t\t\t<label class="form-label">Points (Reward)</label>\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\ttype="number" \n\t\t\t\t\t\t\tid="spiralTaskPoints" \n\t\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\t\tvalue="10" \n\t\t\t\t\t\t\tmin="1" \n\t\t\t\t\t\t\tmax="100"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="form-group">\n\t\t\t\t\t\t<label class="form-label">Penalty Points</label>\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\ttype="number" \n\t\t\t\t\t\t\tid="spiralTaskPenalty" \n\t\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\t\tvalue="5" \n\t\t\t\t\t\t\tmin="0" \n\t\t\t\t\t\t\tmax="50"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="form-row">\n\t\t\t\t\t<div class="form-group">\n\t\t\t\t\t\t<label class="form-label">Due Date (Optional)</label>\n\t\t\t\t\t\t<input \n\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\tid="spiralTaskDueDate" \n\t\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\t\tplaceholder="Select a date and time..."\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="form-group">\n\t\t\t\t\t\t<label class="form-label">\n\t\t\t\t\t\t\t<input type="checkbox" id="spiralTaskRepeating" />\n\t\t\t\t\t\t\tRepeating Task\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="form-group" id="spiralRepeatOptions" style="display: none;">\n\t\t\t\t\t<label class="form-label">Repeat Every</label>\n\t\t\t\t\t<select id="spiralRepeatInterval" class="form-input">\n\t\t\t\t\t\t<option value="daily">Daily</option>\n\t\t\t\t\t\t<option value="weekly">Weekly</option>\n\t\t\t\t\t\t<option value="monthly">Monthly</option>\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="modal-actions">\n\t\t\t\t\t<button id="createSpiralTask" class="action-btn approve-btn">Create Task</button>\n\t\t\t\t\t<button id="cancelSpiralTask" class="action-btn delete-btn">Cancel</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t',document.body.appendChild(e);const n=document.getElementById("spiralTaskDueDate");n&&"undefined"!=typeof flatpickr&&flatpickr(n,{enableTime:!0,dateFormat:"Y-m-dTH:i",time_24hr:!0,minuteIncrement:1,placeholder:"Select a date and time..."});const i=document.getElementById("spiralTaskRepeating"),o=document.getElementById("spiralRepeatOptions");i&&o&&i.addEventListener("change",function(){o.style.display=this.checked?"block":"none"}),document.getElementById("createSpiralTask").onclick=async function(){const t=document.getElementById("spiralTaskDescription").value.trim(),n=parseInt(document.getElementById("spiralTaskPoints").value)||10,i=parseInt(document.getElementById("spiralTaskPenalty").value)||5,o=document.getElementById("spiralTaskDueDate").value,a=document.getElementById("spiralTaskRepeating").checked,s=a?document.getElementById("spiralRepeatInterval").value:null;if(!t)return void window.showNotification("Please enter a task description","error");if(o){const t=new Date(o),e=new Date;if(isNaN(t.getTime()))return void window.showNotification("Invalid due date format","error");if(t<e)return void window.showNotification("Due date cannot be in the past","error")}const r={text:t,status:"todo",type:"spiral",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:n,penaltyPoints:i,dueDate:o||null,isRepeating:a,repeatInterval:s,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1,appealStatus:null,appealedAt:null,appealReviewedAt:null,appealReviewedBy:null,acceptedAt:null,appealText:null,rejectedAt:null,rejectedBy:null};try{const{error:o}=await window.supabase.from("tasks").insert([r]);o?window.showNotification("Failed to create spiral task.","error"):(window.showNotification(`Spiral task "${t}" created successfully! Points: ${n}, Penalty: ${i}${a?" (Repeating)":""}`),document.body.removeChild(e),window.hideSpiralGenerator(),u(),await window.fetchTasksInitial())}catch(d){window.showNotification("An error occurred while creating the task.","error")}},document.getElementById("cancelSpiralTask").onclick=function(){document.body.removeChild(e)},e.onclick=function(t){t.target===e&&document.body.removeChild(e)}},{init:function(){o&&cancelAnimationFrame(o),t=document.getElementById("spiral-canvas"),t&&(e=t.getContext("2d"),s=document.getElementById("text-overlay"),r=document.getElementById("text-script"),function(){["speed","radius","arms","thickness","color","opacity","time-offset","rotation"].forEach(t=>{const e=document.getElementById(t);e&&e.addEventListener("input",function(){!function(t,e){const i=n[a];if(!i)return;let o=parseFloat(e)||e;"color"===t&&(o=e);"radius"===t?i.radiusPercent=o:"rotation"===t?i.rotation=o:"time-offset"===t?i.timeOffset=o:i[t]=o}(t,this.value),b()})});["text-interval","text-hold","text-anim-speed","text-size","text-color"].forEach(t=>{const e=document.getElementById(t);e&&e.addEventListener("input",function(){"text-size"===t?s.style.fontSize=this.value+"rem":"text-color"===t&&(s.style.color=this.value),b()})}),document.getElementById("bg-color").addEventListener("input",function(){const n=this.value;if(e){const i=e.fillStyle;e.fillStyle=n,i!==n&&e.fillRect(0,0,t.width,t.height)}})}(),window.addEventListener("resize",p,!1),p(),0===n.length&&g(),C(),m())},addSpiral:g,deleteSpiral:function(t){n[t]&&(n.splice(t,1),a=Math.max(0,a-1),y(),0===n.length?f():k(n[a]))},clearAllSpirals:h,startTextSequence:function(){i&&T(),i=!0,c=0,function(){const t=r.value.split("\n").filter(t=>t.trim());d=[],t.forEach(t=>{if((t=t.trim()).startsWith("DELAY:")){const e=parseInt(t.substring(6));isNaN(e)||d.push({type:"delay",value:e})}else t&&d.push({type:"text",value:t})})}(),I()},stopTextSequence:T,saveSpiralConfig:function(){const t=D(),e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download="spiral-config.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),window.showNotification("Spiral configuration saved successfully.","success")},loadSpiralConfig:function(){const t=document.getElementById("config-file");t&&t.click()},handleSpiralConfigFile:function(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=function(t){try{B(JSON.parse(t.target.result)),window.showNotification("Spiral configuration loaded successfully.","success")}catch(e){window.showNotification("Failed to load configuration. Invalid file format.","error")}},n.readAsText(e)},sendSpiralConfigAsTask:async function(){const t=D();window.showSpiralTaskConfigModal(t),u()},getSpiralConfiguration:D,applyConfiguration:B,initDefaultText:C,stop:u}}(),window.costTracker=function(){let t=null;class e{constructor(){if(t)return t;this.startTime=0,this.elapsedTime=0,this.timerInterval=null,this.costInterval=null,this.isRunning=!1,this.totalCost=0,this.penalties=[],this.activeLiveTrackerId=null,this.isInitialized=!1,t=this}initializeElements(){return this.timerDisplay=document.getElementById("timer"),this.currentCostDisplay=document.getElementById("currentCost"),this.finalTotalDiv=document.getElementById("finalTotal"),this.billBreakdownDiv=document.getElementById("billBreakdown"),this.startBtn=document.getElementById("startBtn"),this.stopBtn=document.getElementById("stopBtn"),this.resetBtn=document.getElementById("resetBtn"),this.startLiveBtn=document.getElementById("startLiveBtn"),this.rateInput=document.getElementById("rate"),this.currencySelect=document.getElementById("currency"),this.intervalSelect=document.getElementById("interval"),this.penaltyDescriptionInput=document.getElementById("penaltyDescription"),this.penaltyAmountInput=document.getElementById("penaltyAmount"),this.addPenaltyBtn=document.getElementById("addPenaltyBtn"),this.penaltyListDiv=document.getElementById("penaltyList"),!(!this.timerDisplay||!this.currentCostDisplay)}bindEvents(){this.unbindEvents(),this.startBtn&&(this.startBtn.onclick=()=>this.start()),this.stopBtn&&(this.stopBtn.onclick=()=>this.stop()),this.resetBtn&&(this.resetBtn.onclick=()=>this.reset()),this.startLiveBtn&&(this.startLiveBtn.onclick=()=>this.startLive()),this.currencySelect&&(this.currencySelect.onchange=()=>this.calculateCurrentCost()),this.rateInput&&(this.rateInput.oninput=()=>this.calculateCurrentCost()),this.addPenaltyBtn&&(this.addPenaltyBtn.onclick=()=>this.addPenalty()),this.penaltyDescriptionInput&&(this.penaltyDescriptionInput.onkeypress=t=>{"Enter"===t.key&&this.addPenalty()}),this.penaltyAmountInput&&(this.penaltyAmountInput.onkeypress=t=>{"Enter"===t.key&&this.addPenalty()})}unbindEvents(){this.startBtn&&(this.startBtn.onclick=null),this.stopBtn&&(this.stopBtn.onclick=null),this.resetBtn&&(this.resetBtn.onclick=null),this.startLiveBtn&&(this.startLiveBtn.onclick=null),this.currencySelect&&(this.currencySelect.onchange=null),this.rateInput&&(this.rateInput.oninput=null),this.addPenaltyBtn&&(this.addPenaltyBtn.onclick=null),this.penaltyDescriptionInput&&(this.penaltyDescriptionInput.onkeypress=null),this.penaltyAmountInput&&(this.penaltyAmountInput.onkeypress=null)}init(){return this.clearAllIntervals(),!!this.initializeElements()&&(this.bindEvents(),this.resetToCleanState(),this.updateDisplay(),this.checkForActiveLiveTracker(),this.isInitialized=!0,!0)}resetToCleanState(){this.clearAllIntervals(),this.isRunning=!1,this.elapsedTime=0,this.totalCost=0,this.penalties=[],this.timerDisplay&&(this.timerDisplay.textContent="00:00:00"),this.currentCostDisplay&&(this.currentCostDisplay.textContent="€0.00"),this.finalTotalDiv&&this.finalTotalDiv.classList.remove("show"),this.startBtn&&(this.startBtn.disabled=!1,this.startBtn.textContent="Start"),this.stopBtn&&(this.stopBtn.disabled=!0,this.stopBtn.textContent="Stop"),this.updatePenaltyList()}clearAllIntervals(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.costInterval&&(clearInterval(this.costInterval),this.costInterval=null)}start(){var t;this.isRunning||this.isInitialized&&(this.startTime=Date.now()-this.elapsedTime,this.isRunning=!0,this.timerInterval=setInterval(()=>this.updateTimer(),100),this.costInterval=setInterval(()=>this.incrementCost(),parseInt((null==(t=this.intervalSelect)?void 0:t.value)||"60000")),this.startBtn&&(this.startBtn.disabled=!0,this.startBtn.textContent="Running..."),this.stopBtn&&(this.stopBtn.disabled=!1,this.stopBtn.textContent="Stop"),this.finalTotalDiv&&this.finalTotalDiv.classList.remove("show"))}stop(){this.isRunning&&(this.isRunning=!1,this.clearAllIntervals(),this.activeLiveTrackerId||(this.startBtn&&(this.startBtn.disabled=!1,this.startBtn.textContent="Start"),this.stopBtn&&(this.stopBtn.disabled=!0,this.stopBtn.textContent="Stop"),this.showFinalTotal()))}reset(){this.stop(),this.resetToCleanState(),this.startLiveBtn&&(this.startLiveBtn.textContent="Start Live Tracker",this.startLiveBtn.className="action-btn check-btn",this.startLiveBtn.onclick=()=>this.startLive()),this.activeLiveTrackerId=null}updateTimer(){if(!this.isRunning||!this.timerDisplay)return;this.elapsedTime=Date.now()-this.startTime,this.calculateCurrentCost();const t=Math.floor(this.elapsedTime/1e3),e=Math.floor(t/3600),n=Math.floor(t%3600/60),i=t%60,o=`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`;this.timerDisplay&&this.timerDisplay.isConnected?this.timerDisplay.textContent=o:this.stop()}calculateCurrentCost(){const t=this.rateInput?parseFloat(this.rateInput.value)||0:50,e=this.intervalSelect?parseInt(this.intervalSelect.value):6e4,n=this.elapsedTime/e;this.totalCost=n*t,this.updateDisplay()}updateDisplay(){const t=this.currencySelect?this.currencySelect.value:"€",e=this.formatCurrency(this.totalCost,t);this.currentCostDisplay&&this.currentCostDisplay.isConnected&&(this.currentCostDisplay.textContent=e)}incrementCost(){this.calculateCurrentCost(),this.currentCostDisplay&&this.currentCostDisplay.isConnected&&(this.currentCostDisplay.classList.add("pulse"),setTimeout(()=>{this.currentCostDisplay&&this.currentCostDisplay.isConnected&&this.currentCostDisplay.classList.remove("pulse")},500))}async startLive(){var t,e,n;if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to start live trackers","error");await window.stopAllActiveCostTrackers();const i=parseFloat((null==(t=this.rateInput)?void 0:t.value)||"50"),o=(null==(e=this.currencySelect)?void 0:e.value)||"€",a=parseInt((null==(n=this.intervalSelect)?void 0:n.value)||"60000"),s=this.penalties.map(t=>({id:t.id,description:t.description,amount:t.amount,added_at:(new Date).toISOString()}));try{const t=await window.startLiveCostTracker("Live Cost Tracker",i,o,a,s);t&&(this.activeLiveTrackerId=t,this.start(),this.startLiveBtn&&(this.startLiveBtn.textContent="Stop Live Tracker",this.startLiveBtn.className="action-btn delete-btn",this.startLiveBtn.onclick=()=>this.stopLive()),this.startBtn&&(this.startBtn.disabled=!0),this.stopBtn&&(this.stopBtn.disabled=!0),window.showNotification("Live cost tracker started with local timer!"))}catch(r){window.showNotification("Failed to start live tracker","error")}}async stopLive(){if(this.activeLiveTrackerId)try{this.stop(),await window.stopLiveCostTracker(this.activeLiveTrackerId,!0),this.activeLiveTrackerId=null,this.startLiveBtn&&(this.startLiveBtn.textContent="Start Live Tracker",this.startLiveBtn.className="action-btn check-btn",this.startLiveBtn.onclick=()=>this.startLive()),this.startBtn&&(this.startBtn.disabled=!1),this.stopBtn&&(this.stopBtn.disabled=!0),window.showNotification("Live cost tracker stopped and invoice created!")}catch(t){window.showNotification("Failed to stop live tracker","error")}}checkForActiveLiveTracker(){}addPenalty(){var t,e;const n=(null==(t=this.penaltyDescriptionInput)?void 0:t.value.trim())||"",i=this.penaltyAmountInput&&parseFloat(this.penaltyAmountInput.value)||0;n&&i>0?(this.activeLiveTrackerId?(window.addPenaltyToLiveTracker(this.activeLiveTrackerId,n,i),this.penalties.push({description:n,amount:i,id:Date.now()})):this.penalties.push({description:n,amount:i,id:Date.now()}),this.updatePenaltyList(),this.penaltyDescriptionInput&&(this.penaltyDescriptionInput.value=""),this.penaltyAmountInput&&(this.penaltyAmountInput.value=""),window.showNotification(`Penalty added: ${n} (${this.formatCurrency(i,(null==(e=this.currencySelect)?void 0:e.value)||"€")})`,"success")):window.showNotification("Please enter a valid description and amount","error")}updatePenaltyList(){var t;const e=(null==(t=this.currencySelect)?void 0:t.value)||"€";if(!this.penaltyListDiv)return;let n="";0===this.penalties.length?n='<div class="empty-penalty-state" style="color: var(--terminal-gray); font-style: italic; padding: 10px; text-align: center;">No penalties added yet</div>':this.penalties.forEach(t=>{n+=`\n\t\t\t\t\t\t<div class="penalty-item">\n\t\t\t\t\t\t\t<div class="penalty-description">${window.escapeHtml?window.escapeHtml(t.description):t.description}</div>\n\t\t\t\t\t\t\t<div class="penalty-amount">${this.formatCurrency(t.amount,e)}</div>\n\t\t\t\t\t\t\t<button class="remove-penalty" onclick="window.costTracker.removePenalty(${t.id})" title="Remove penalty">×</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`}),this.penaltyListDiv.innerHTML=n}removePenalty(t){this.activeLiveTrackerId&&window.removePenaltyFromLiveTracker(this.activeLiveTrackerId,t),this.penalties=this.penalties.filter(e=>e.id!==t),this.updatePenaltyList()}formatCurrency(t,e){return`${e}${t.toFixed(2)}`}showFinalTotal(){this.generateBillBreakdown(),this.finalTotalDiv&&this.finalTotalDiv.classList.add("show")}generateBillBreakdown(){var t,e;const n=(null==(t=this.currencySelect)?void 0:t.value)||"€",i=this.getIntervalText(),o=this.getElapsedTimeText();let a="",s=this.formatCurrency(this.totalCost,n);a+=`\n\t\t\t\t<div class="bill-item">\n\t\t\t\t\t<div class="bill-description">${o} @ ${this.formatCurrency(parseFloat((null==(e=this.rateInput)?void 0:e.value)||50),n)} per ${i}</div>\n\t\t\t\t\t<div class="bill-amount">${s}</div>\n\t\t\t\t</div>\n\t\t\t`;let r=0;this.penalties.forEach(t=>{r+=t.amount,a+=`\n\t\t\t\t\t<div class="bill-item">\n\t\t\t\t\t\t<div class="bill-description">${t.description}</div>\n\t\t\t\t\t\t<div class="bill-amount">${this.formatCurrency(t.amount,n)}</div>\n\t\t\t\t\t</div>\n\t\t\t\t`});const d=this.totalCost+r;a+=`\n\t\t\t\t<div class="bill-item">\n\t\t\t\t\t<div class="bill-description"><strong>TOTAL</strong></div>\n\t\t\t\t\t<div class="bill-amount">${this.formatCurrency(d,n)}</div>\n\t\t\t\t</div>\n\t\t\t`,this.billBreakdownDiv&&(this.billBreakdownDiv.innerHTML=a)}getIntervalText(){switch(this.intervalSelect?parseInt(this.intervalSelect.value):6e4){case 1e3:return"second";case 6e4:return"minute";case 36e5:return"hour";default:return"unit"}}getElapsedTimeText(){const t=Math.floor(this.elapsedTime/1e3),e=Math.floor(t/3600),n=Math.floor(t%3600/60),i=t%60;return e>0?`${e}h ${n}m ${i}s`:n>0?`${n}m ${i}s`:`${i}s`}getCostDetails(){var t,e;const n=(null==(t=this.currencySelect)?void 0:t.value)||"€",i={description:`${this.getElapsedTimeText()} @ ${this.formatCurrency(parseFloat((null==(e=this.rateInput)?void 0:e.value)||50),n)} per ${this.getIntervalText()}`,amount:this.formatCurrency(this.totalCost,n)},o=this.penalties.map(t=>({description:t.description,amount:this.formatCurrency(t.amount,n)})),a=this.totalCost+this.penalties.reduce((t,e)=>t+e.amount,0);return{timeBasedCost:i,penalties:o,grandTotal:this.formatCurrency(a,n),timestamp:(new Date).toISOString()}}}return{init:()=>(t||(t=new e),t.init()),removePenalty:e=>null==t?void 0:t.removePenalty(e),async sendCostConfigAsTask(){if(!t)return;const e=t.getCostDetails(),n=`💰 INVOICE - Cost Tracker\n\nTime-based Cost: ${e.timeBasedCost.description} = ${e.timeBasedCost.amount}`;let i="";e.penalties&&e.penalties.length>0&&(i="\n\nAdditional Costs:\n"+e.penalties.map(t=>`• ${t.description}: ${t.amount}`).join("\n"));const o={text:n+i+`\n\n💸 TOTAL AMOUNT DUE: ${e.grandTotal}\n\n⚠️ This is an invoice that must be approved for payment. Failure to approve will result in penalty points.`,status:"todo",type:"cost-tracker",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:0,penaltyPoints:100,dueDate:new Date(Date.now()+6048e5).toISOString(),isRepeating:!1,repeatInterval:null};try{const{error:n}=await window.supabase.from("tasks").insert([o]);n?window.showNotification("Failed to send invoice.","error"):(window.showNotification(`Invoice sent successfully! Total: ${e.grandTotal} (Penalty for non-payment: 100 points)`),t.reset(),window.hideCostTracker(),await window.fetchTasksInitial())}catch(a){window.showNotification("Failed to send invoice.","error")}},resetOnClose(){t&&!t.activeLiveTrackerId&&t.reset()},getInstance:()=>t}}(),window.showError=function(t){var e=document.getElementById("errorMessage");e&&(e.textContent=t,e.style.display="block")},window.showSuccess=function(t){var e=document.getElementById("successMessage");e&&(e.textContent=t,e.style.display="block")},window.hideError=function(){var t=document.getElementById("errorMessage"),e=document.getElementById("successMessage");t&&(t.style.display="none"),e&&(e.style.display="none")},window.showNotification=function(t,e){void 0===e&&(e="success");var n=document.createElement("div");n.className="notification "+e,n.textContent=t,document.body.appendChild(n),setTimeout(function(){n.classList.add("show")},100),setTimeout(function(){n.classList.remove("show"),setTimeout(function(){document.body.contains(n)&&document.body.removeChild(n)},300)},3e3)},window.escapeHtml=function(t){var e=document.createElement("div");return e.textContent=t,e.innerHTML.replace(/`/g,"&#96;")},window.formatDate=function(t){if(!t)return"";var e=new Date(t);return e.toLocaleDateString()+" "+e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},window.getStatusClass=function(t,e,n,i){return"cost-tracker"===n?"pending_approval"===t?"status-pending":"completed"===t?"status-completed":"failed"===t?"status-overdue":"status-pending":"demerit"===n?"pending"===i?"status-pending-appeal":"approved"===i?"status-completed":"denied"===i?"status-overdue":"demerit_accepted"===t?"status-demerit-accepted":"status-demerit":e?"status-overdue":"completed"===t?"status-completed":"failed"===t?"status-overdue":"status-pending"},window.getStatusText=function(t,e,n,i){return"cost-tracker"===n?"todo"===t?"Payment Required":"pending_approval"===t?"Payment Pending Approval":"completed"===t?"Payment Approved":"failed"===t?"Payment Denied":"Invoice":"demerit"===n?"pending"===i?"Appeal Pending":"approved"===i?"Appeal Approved":"denied"===i?"Appeal Denied":"demerit_accepted"===t?"Demerit Accepted":"Demerit Issued":e?"Overdue":"completed"===t?"Completed":"failed"===t?"Failed":"pending_approval"===t?"Pending Approval":"To Do"},window.getSuggestionStatusClass=function(t){switch(t){case"approved":return"status-completed";case"rejected":return"status-overdue";default:return"status-pending"}},window.isTaskOverdue=function(t){return!(!t.dueDate||"completed"===t.status)&&new Date(t.dueDate)<new Date},window.extractTotalFromTaskText=function(t){const e=t.match(/TOTAL AMOUNT DUE:\s*([€£$]\d+\.\d+)/);return e?e[1]:null},window.showModal=function(t){var e=document.getElementById("eventModal"),n=document.getElementById("modalContent"),i=document.getElementById("closeModal");e&&n&&(n.innerHTML=t,e.classList.remove("hidden"),i&&(i.onclick=function(){e.classList.add("hidden")}),e.onclick=function(t){t.target===e&&e.classList.add("hidden")})},window.showConfirmModal=function(t,e){var n=document.createElement("div");n.className="modal-overlay",n.innerHTML='<div class="modal-content"><p>'+t+'</p><div class="modal-actions"><button id="modalConfirm" class="action-btn approve-btn">Confirm</button><button id="modalCancel" class="action-btn delete-btn">Cancel</button></div></div>',document.body.appendChild(n),document.getElementById("modalConfirm").onclick=function(){e(!0),document.body.removeChild(n)},document.getElementById("modalCancel").onclick=function(){e(!1),document.body.removeChild(n)}},window.showAppealModal=function(t,e){var n=document.createElement("div");n.className="modal-overlay",n.innerHTML='<div class="modal-content"><h3>Appeal Demerit Task</h3><p><strong>Task:</strong> '+window.escapeHtml(t.text)+"</p><p><strong>Penalty:</strong> -"+t.penaltyPoints+' points</p><div class="appeal-warning"><div class="warning-title">⚠️ Appeal Risk Warning</div><div>If approved: +'+t.penaltyPoints+" points restored</div><div>If denied: -"+t.penaltyPoints+" additional points (double penalty)</div><div><strong>Total risk if denied: "+2*t.penaltyPoints+' points</strong></div></div><div class="form-group"><label class="form-label" for="appealTextInput">Reason for Appeal (Required)</label><textarea id="appealTextInput" class="form-input" rows="4" placeholder="Explain why you are appealing this demerit..."></textarea></div><div id="appealError" class="error-message" style="display:none; margin-top: 10px;"></div><div class="modal-actions"><button id="modalSubmitAppeal" class="action-btn approve-btn">Submit Appeal</button><button id="modalCancelAppeal" class="action-btn delete-btn">Cancel</button></div></div>',document.body.appendChild(n),document.getElementById("modalSubmitAppeal").onclick=function(){var t=document.getElementById("appealTextInput").value.trim(),i=document.getElementById("appealError");t.length<10?(i.textContent="Appeal text must be at least 10 characters long.",i.style.display="block"):(e(t),document.body.removeChild(n))},document.getElementById("modalCancelAppeal").onclick=function(){document.body.removeChild(n)}};window.users={skeen:{role:"skeen",displayName:"Sir",permissions:["create_task","approve_task","delete_task","view_all_tasks","manage_users","view_dashboard","approve_suggestions","manage_rewards"],points:0},schinken:{role:"schinken",displayName:"Pig",permissions:["check_task","view_assigned_tasks","suggest_task"],points:0}},window.currentUser=null,window.tasks=[],window.suggestions=[],window.userActivityLog=[],window.rewards=[],window.userRewardPurchases=[],window.rewardSystemSettings={},window.activeCostTrackers=[],window.liveCostTrackerInterval=null,window.liveCostTrackerUpdateInterval=null,window.activeLiveTrackerId=null,window.currentLiveTracker=null,window.taskIdCounter=1,window.suggestionIdCounter=1,window.overdueCheckIntervalId=null,window.OVERDUE_CHECK_INTERVAL=3e5,window.activeTab="tasks",window.addEventListener("load",function(){window.initializeSupabaseClient(window.supabaseConfig.supabaseUrl,window.supabaseConfig.supabaseAnonKey),window.attemptAutoLogin()}),document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("loginForm");t&&t.addEventListener("submit",window.handleLogin);const e=document.getElementById("suggestForm");e&&e.addEventListener("submit",function(t){t.preventDefault(),window.submitTaskSuggestion()});const n=document.getElementById("isRepeating");n&&n.addEventListener("change",function(){const t=document.getElementById("repeatOptions");t&&(t.style.display=this.checked?"block":"none")});const i=document.getElementById("isDemerit");i&&i.addEventListener("change",function(){const t=document.getElementById("demeritWarning");t&&(t.style.display=this.checked?"block":"none");const e=document.getElementById("taskPoints"),n=document.getElementById("penaltyPoints"),i=document.getElementById("taskDueDate");this.checked?(e&&(e.closest(".form-group").style.display="none"),i&&(i.closest(".form-group").style.display="none"),n&&(n.closest(".form-group").style.display="block")):(e&&(e.closest(".form-group").style.display="block"),i&&(i.closest(".form-group").style.display="block"),n&&(n.closest(".form-group").style.display="block"))});const o=document.getElementById("saveRewardBtn");o&&o.addEventListener("click",window.saveReward);const a=document.getElementById("cancelEditRewardBtn");a&&a.addEventListener("click",window.cancelEditReward),flatpickr("#taskDueDate",{enableTime:!0,dateFormat:"Y-m-dTH:i",time_24hr:!0,minuteIncrement:1,placeholder:"Select a date and time...",appendTo:document.getElementById("taskDueDate").parentElement}),flatpickr("#suggestedDueDate",{enableTime:!0,dateFormat:"Y-m-dTH:i",time_24hr:!0,minuteIncrement:1,placeholder:"Select a date and time...",appendTo:document.getElementById("suggestedDueDate").parentElement})}),window.hasPermission=function(t){const e=window.users[window.currentUser];return e&&e.permissions.includes(t)},window.bulletproofStopTracker=async function(t){if(t)if(window.supabase)try{const{data:e,error:n}=await window.supabase.from("active_cost_trackers").select("*").eq("id",t).single();if(n)return void alert(`Error finding tracker: ${n.message}`);if(!e)return void alert("Error: Tracker not found in database");const{data:i,error:o}=await window.supabase.from("active_cost_trackers").update({status:"stopped",updated_at:(new Date).toISOString()}).eq("id",t).select();if(o)return void alert(`Error stopping tracker: ${o.message}`);if(!i||0===i.length)return void alert("Error: Update failed - no data returned");const{data:a,error:s}=await window.supabase.from("active_cost_trackers").select("status").eq("id",t).single();if(s)alert("Warning: Could not verify tracker was stopped");else if("stopped"!==a.status)return void alert(`Error: Tracker status is still "${a.status}" instead of "stopped"`);window.currentLiveTracker=null,window.activeLiveTrackerId=null,window.activeCostTrackers&&(window.activeCostTrackers=window.activeCostTrackers.filter(e=>e.id!==t)),window.clearLiveCostTrackerIntervals&&window.clearLiveCostTrackerIntervals();const r=document.getElementById("liveCostTracker");r&&r.classList.add("hidden"),window.renderActiveCostTrackersAdmin&&window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount&&window.updateActiveCostTrackersCount(),"schinken"===window.currentUser&&window.updateLiveCostTracker&&(window.userManuallyStoppedTracker=!0,setTimeout(()=>{window.userManuallyStoppedTracker=!1},5e3)),alert("✅ Tracker stopped successfully!"),window.showNotification&&window.showNotification("Tracker stopped! Create invoice manually if needed.","success")}catch(e){alert(`Critical error: ${e.message}`)}else alert("Error: Database connection not available");else alert("Error: No tracker ID provided")},window.handleStopTrackerClick=async function(t){confirm("Are you sure you want to stop this tracker?")&&await window.bulletproofStopTracker(t)},window.emergencyStopAll=async function(){if(confirm("EMERGENCY STOP: This will stop ALL running trackers. Are you sure?"))try{const{data:t,error:e}=await window.supabase.from("active_cost_trackers").select("id, description").eq("status","running");if(e)return void alert("Failed to fetch running trackers");if(!t||0===t.length)return void alert("No running trackers found");const{error:n}=await window.supabase.from("active_cost_trackers").update({status:"stopped",updated_at:(new Date).toISOString(),notes:"Emergency stop - admin intervention"}).eq("status","running");if(n)return void alert("Failed to stop trackers");window.currentLiveTracker=null,window.activeLiveTrackerId=null,window.activeCostTrackers=[];const i=document.getElementById("liveCostTracker");i&&i.classList.add("hidden"),window.clearLiveCostTrackerIntervals&&window.clearLiveCostTrackerIntervals(),window.renderActiveCostTrackersAdmin&&window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount&&window.updateActiveCostTrackersCount(),alert(`✅ Emergency stop completed! Stopped ${t.length} tracker(s)`)}catch(t){alert(`Emergency stop failed: ${t.message}`)}},window.bulletproofStopTrackerV2=async function(t){if(t&&window.supabase)try{window.activeCostTrackers&&(window.activeCostTrackers=window.activeCostTrackers.filter(e=>e.id!==t)),window.currentLiveTracker&&window.currentLiveTracker.id===t&&(window.currentLiveTracker=null),window.activeLiveTrackerId===t&&(window.activeLiveTrackerId=null);const e=document.getElementById("liveCostTracker");e&&e.classList.add("hidden"),window.clearLiveCostTrackerIntervals&&window.clearLiveCostTrackerIntervals(),window.renderActiveCostTrackersAdmin&&window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount&&window.updateActiveCostTrackersCount();const{data:n,error:i}=await window.supabase.from("active_cost_trackers").update({status:"stopped",updated_at:(new Date).toISOString()}).eq("id",t).select();if(i)return alert(`Database update failed: ${i.message}`),void(await window.fetchActiveCostTrackersInitial());window.ignoreNextRealTimeUpdate=!0,setTimeout(()=>{window.ignoreNextRealTimeUpdate=!1},2e3),alert("✅ Tracker stopped successfully!")}catch(e){alert(`Critical error: ${e.message}`),await window.fetchActiveCostTrackersInitial()}else alert("Error: Invalid tracker ID or no database connection")},window.fetchActiveCostTrackersWithRetry=async function(t=0){try{const{data:t,error:e}=await window.supabase.from("active_cost_trackers").select("*").eq("status","running");if(e)throw e;window.activeCostTrackers=t.sort((t,e)=>new Date(e.started_at)-new Date(t.started_at)),"skeen"===window.currentUser?(window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount()):"schinken"===window.currentUser&&window.updateLiveCostTracker()}catch(e){t<3?setTimeout(()=>{window.fetchActiveCostTrackersWithRetry(t+1)},200*(t+1)):window.showError("Failed to load active cost trackers after retries.")}},window.handleStopTrackerClickV2=async function(t){confirm("Are you sure you want to stop this tracker?")&&(window.userManuallyStoppedTracker=!0,setTimeout(()=>{window.userManuallyStoppedTracker=!1},5e3),await window.bulletproofStopTrackerV2(t))},window.attemptAutoLogin=async function(){const t=localStorage.getItem("rememberedUser");t&&window.users&&window.users[t]?(window.currentUser=t,await window.showMainApp()):window.showLogin()},window.handleLogin=async function(t){t.preventDefault();const e=document.getElementById("username"),n=document.getElementById("password"),i=document.getElementById("rememberMe"),o=e.value.trim(),a=n.value,s=!!i&&i.checked,{data:r,error:d}=await window.supabase.from("users").select("username, password, role").eq("username",o).eq("password",a).limit(1);if(d||!r||0===r.length)return void window.showError("Invalid username or password");const c=r[0];window.users[c.username]?(window.currentUser=c.username,s?localStorage.setItem("rememberedUser",window.currentUser):localStorage.removeItem("rememberedUser"),await window.showMainApp(),window.hideError()):window.showError("User configuration not found")},window.logout=function(){window.currentUser&&window.logUserActivity("logout"),localStorage.removeItem("rememberedUser"),window.unsubscribe&&(window.unsubscribe.tasks&&window.supabase.removeChannel(window.unsubscribe.tasks),window.unsubscribe.suggestions&&window.supabase.removeChannel(window.unsubscribe.suggestions),window.unsubscribe.activity&&window.supabase.removeChannel(window.unsubscribe.activity),window.unsubscribe.userProfiles&&window.supabase.removeChannel(window.unsubscribe.userProfiles),window.unsubscribe.rewards&&window.supabase.removeChannel(window.unsubscribe.rewards),window.unsubscribe.userRewardPurchases&&window.supabase.removeChannel(window.unsubscribe.userRewardPurchases),window.unsubscribe.rewardSystemSettings&&window.supabase.removeChannel(window.unsubscribe.rewardSystemSettings),window.unsubscribe.activeCostTrackers&&window.supabase.removeChannel(window.unsubscribe.activeCostTrackers),window.unsubscribe=null),window.overdueCheckIntervalId&&(clearInterval(window.overdueCheckIntervalId),window.overdueCheckIntervalId=null),window.liveCostTrackerInterval&&(clearInterval(window.liveCostTrackerInterval),window.liveCostTrackerInterval=null),window.liveCostTrackerUpdateInterval&&(clearInterval(window.liveCostTrackerUpdateInterval),window.liveCostTrackerUpdateInterval=null),window.currentLiveTracker=null,window.currentUser=null,document.getElementById("username").value="",document.getElementById("password").value="",window.hideError(),window.showLogin()};let t=null;window.initializeSupabaseClient=function(e,n){t||(t=window.supabase.createClient(e,n),window.supabase=t)},window.loadData=async function(){if(!t)return;window.unsubscribe&&(window.unsubscribe.tasks&&t.removeChannel(window.unsubscribe.tasks),window.unsubscribe.suggestions&&t.removeChannel(window.unsubscribe.suggestions),window.unsubscribe.activity&&t.removeChannel(window.unsubscribe.activity),window.unsubscribe.userProfiles&&t.removeChannel(window.unsubscribe.userProfiles),window.unsubscribe.rewards&&t.removeChannel(window.unsubscribe.rewards),window.unsubscribe.userRewardPurchases&&t.removeChannel(window.unsubscribe.userRewardPurchases),window.unsubscribe.rewardSystemSettings&&t.removeChannel(window.unsubscribe.rewardSystemSettings),window.unsubscribe.activeCostTrackers&&t.removeChannel(window.unsubscribe.activeCostTrackers),window.unsubscribe={});try{window.taskIdCounter=Math.max(await window.fetchCounter("taskIdCounter"),await window.fetchMaxId("tasks")),window.suggestionIdCounter=Math.max(await window.fetchCounter("suggestionIdCounter"),await window.fetchMaxId("suggestions")),await window.upsertCounter("taskIdCounter",window.taskIdCounter),await window.upsertCounter("suggestionIdCounter",window.suggestionIdCounter)}catch(c){}await window.fetchTasksInitial(),await window.fetchSuggestionsInitial(),await window.fetchUserActivityInitial(),await window.fetchUserProfilesInitial(),await window.fetchRewardsInitial(),await window.fetchUserRewardPurchasesInitial(),await window.fetchRewardSystemSettingsInitial(),await window.fetchActiveCostTrackersInitial();const e=t.channel("tasks_channel").on("postgres_changes",{event:"*",schema:"public",table:"tasks"},t=>{try{if("INSERT"===t.eventType)window.tasks.unshift(t.new);else if("UPDATE"===t.eventType){const e=window.tasks.findIndex(e=>e.id===t.old.id);-1!==e&&(window.tasks[e]=t.new)}else"DELETE"===t.eventType&&(window.tasks=window.tasks.filter(e=>e.id!==t.old.id));window.tasks.sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)),window.renderTasks(),window.updateStats(),"calendar"===window.activeTab&&window.renderCalendar()}catch(c){window.showNotification("An error occurred with task updates.","error")}}).subscribe(),n=t.channel("suggestions_channel").on("postgres_changes",{event:"*",schema:"public",table:"suggestions"},t=>{try{if("INSERT"===t.eventType)window.suggestions.unshift(t.new);else if("UPDATE"===t.eventType){const e=window.suggestions.findIndex(e=>e.id===t.old.id);-1!==e&&(window.suggestions[e]=t.new)}else"DELETE"===t.eventType&&(window.suggestions=window.suggestions.filter(e=>e.id!==t.old.id));window.suggestions.sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)),"skeen"===window.currentUser?window.renderTasks():window.renderSuggestions()}catch(c){window.showNotification("An error occurred with suggestion updates.","error")}}).subscribe(),i=t.channel("activity_channel").on("postgres_changes",{event:"*",schema:"public",table:"userActivity"},t=>{try{if("INSERT"===t.eventType)window.userActivityLog.unshift(t.new),window.userActivityLog.length>50&&(window.userActivityLog=window.userActivityLog.slice(0,50));else if("UPDATE"===t.eventType){const e=window.userActivityLog.findIndex(e=>e.id===t.old.id);-1!==e&&(window.userActivityLog[e]=t.new)}else"DELETE"===t.eventType&&(window.userActivityLog=window.userActivityLog.filter(e=>e.id!==t.old.id));window.userActivityLog.sort((t,e)=>new Date(e.timestamp)-new Date(t.timestamp)),window.renderDashboard()}catch(c){window.showNotification("An error occurred with activity updates.","error")}}).subscribe(),o=t.channel("user_profiles_channel").on("postgres_changes",{event:"*",schema:"public",table:"userProfiles"},t=>{try{if("INSERT"===t.eventType||"UPDATE"===t.eventType){const e=t.new,n=e.username;window.users[n]&&(window.users[n].points=e.points||0)}window.updateUserPoints(),window.renderUserProgress()}catch(c){window.showNotification("An error occurred with user data updates.","error")}}).subscribe(),a=t.channel("rewards_channel").on("postgres_changes",{event:"*",schema:"public",table:"rewards"},t=>{if("INSERT"===t.eventType)window.rewards.push(t.new);else if("UPDATE"===t.eventType){const e=window.rewards.findIndex(e=>e.id===t.old.id);-1!==e&&(window.rewards[e]=t.new)}else"DELETE"===t.eventType&&(window.rewards=window.rewards.filter(e=>e.id!==t.old.id));window.rewards.sort((t,e)=>t.title.localeCompare(e.title)),"shop"!==window.activeTab&&"skeen"!==window.currentUser||(window.renderRewards(),"skeen"===window.currentUser&&window.renderAdminRewardManagement())}).subscribe(),s=t.channel("user_reward_purchases_channel").on("postgres_changes",{event:"*",schema:"public",table:"userRewardPurchases"},async t=>{await window.fetchUserRewardPurchasesInitial(),"skeen"!==window.currentUser&&"shop"!==window.activeTab||(window.renderUserRewardPurchases(),window.renderPendingAuthorizations())}).subscribe(),r=t.channel("reward_system_settings_channel").on("postgres_changes",{event:"*",schema:"public",table:"rewardSystemSettings"},async t=>{"UPDATE"!==t.eventType&&"INSERT"!==t.eventType||(window.rewardSystemSettings=t.new,window.checkForRewardLimitReset(),"skeen"!==window.currentUser||"dashboard"!==window.activeTab&&"adminSettings"!==window.activeTab||(window.renderDashboard(),window.renderAdminRewardSettings()))}).subscribe(),d=t.channel("active_cost_trackers_channel").on("postgres_changes",{event:"*",schema:"public",table:"active_cost_trackers"},async t=>{if(await new Promise(t=>setTimeout(t,5e3)),await window.fetchActiveCostTrackersInitial(),"UPDATE"===t.eventType&&"stopped"===t.new.status){const e=t.new.id;if("schinken"===window.currentUser){const t=document.getElementById("liveCostTracker");window.currentLiveTracker&&window.currentLiveTracker.id===e&&(t&&t.classList.add("hidden"),window.clearLiveCostTrackerIntervals(),window.currentLiveTracker=null,window.activeLiveTrackerId=null,window.userManuallyStoppedTracker=!0,setTimeout(()=>{window.userManuallyStoppedTracker=!1},5e3))}}else"INSERT"===t.eventType&&"running"===t.new.status&&(window.userManuallyStoppedTracker=!1);"skeen"===window.currentUser?(window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount()):"schinken"===window.currentUser&&(window.userManuallyStoppedTracker||setTimeout(()=>{window.updateLiveCostTracker()},100))}).subscribe();window.unsubscribe={tasks:e,suggestions:n,activity:i,userProfiles:o,rewards:a,userRewardPurchases:s,rewardSystemSettings:r,activeCostTrackers:d},window.checkForRewardLimitReset()},window.fetchMaxId=async function(e){const{data:n,error:i}=await t.from(e).select("id").order("id",{ascending:!1}).limit(1);return i?1:n&&n.length>0&&n[0].id?n[0].id+1:1},window.fetchCounter=async function(e){const{data:n,error:i}=await t.from("metadata").select(e).eq("id","counters").limit(1);return i||!n||0===n.length?1:n[0][e]||1},window.upsertCounter=async function(e,n){const i={id:"counters"};i[e]=n;const{error:o}=await t.from("metadata").upsert(i,{onConflict:"id"})},window.checkForOverdueTasks=function(){const e=new Date;window.tasks.forEach(async n=>{if(n.dueDate&&"completed"!==n.status&&"demerit"!==n.type&&"schinken"===n.assignedTo){const i=n.isOverdue;if(new Date(n.dueDate)<e&&!i){n.isOverdue=!0,await window.updateUserPoints(n.assignedTo,n.penaltyPoints,"subtract");const{error:e}=await t.from("tasks").update({isOverdue:!0}).eq("id",n.id)}}})},window.fetchTasksInitial=async function(){const{data:t,error:e}=await window.supabase.from("tasks").select("*");e?window.showError("Failed to load tasks."):(window.tasks=t.sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)),window.renderTasks(),window.updateStats(),"calendar"===window.activeTab&&window.fullCalendarInstance?window.fullCalendarInstance.refetchEvents():"calendar"===window.activeTab&&window.renderCalendar())},window.createTask=async function(){if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to create tasks","error");const t=document.getElementById("taskInput"),e=t.value.trim(),n=!!document.getElementById("isDemerit")&&document.getElementById("isDemerit").checked;if(""===e)return void window.showNotification("Please enter a task description","error");let i;try{if(n){const t=parseInt(document.getElementById("penaltyPoints").value)||5;i={text:e,status:"demerit_issued",type:"demerit",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:0,penaltyPoints:t,dueDate:null,isRepeating:!1,repeatInterval:null,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1,appealStatus:null,appealedAt:null,appealReviewedAt:null,appealReviewedBy:null,acceptedAt:null,appealText:null},await window.updateUserPoints("schinken",t,"subtract")}else{const t=parseInt(document.getElementById("taskPoints").value)||10,n=parseInt(document.getElementById("penaltyPoints").value)||5,o=document.getElementById("taskDueDate").value,a=!!document.getElementById("isRepeating")&&document.getElementById("isRepeating").checked,s=document.getElementById("repeatInterval")?document.getElementById("repeatInterval").value:null;if(o){const t=new Date(o),e=new Date;if(isNaN(t.getTime()))return void window.showNotification("Invalid due date format","error");if(t<e)return void window.showNotification("Due date cannot be in the past","error")}i={text:e,status:"todo",type:"regular",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:t,penaltyPoints:n,dueDate:o||null,isRepeating:a,repeatInterval:a?s:null,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1}}const{error:o}=await window.supabase.from("tasks").insert([i]);if(o)window.showNotification("Failed to create task. Please try again.","error");else{t.value="";const e=document.getElementById("taskPoints"),o=document.getElementById("penaltyPoints"),a=document.getElementById("taskDueDate"),s=document.getElementById("isRepeating"),r=document.getElementById("isDemerit"),d=document.getElementById("demeritWarning"),c=document.getElementById("repeatOptions");e&&(e.value="10",e.closest(".form-group").style.display="block"),o&&(o.value="5"),a&&(a.value="",a.closest(".form-group").style.display="block"),s&&(s.checked=!1),r&&(r.checked=!1),d&&(d.style.display="none"),c&&(c.style.display="none"),n?window.showNotification(`Demerit task issued to user. ${i.penaltyPoints} points deducted.`,"warning"):window.showNotification("Task created successfully!"),await window.fetchTasksInitial()}}catch(o){window.showNotification("An unexpected error occurred. Check console for details.","error")}},window.checkOffTask=async function(t){if(!window.hasPermission("check_task"))return void window.showNotification("You do not have permission to check off tasks","error");const e=window.tasks.find(e=>e.id===t);if(!e)return;if("demerit"===e.type)return void window.showNotification("Demerit tasks cannot be marked as complete.","error");if(e.assignedTo&&e.assignedTo!==window.currentUser)return void window.showNotification("This task is not assigned to you","error");const n={status:"pending_approval",completedAt:(new Date).toISOString(),completedBy:window.currentUser},{error:i}=await window.supabase.from("tasks").update(n).eq("id",t);i?window.showNotification("Failed to update task","error"):(window.showNotification("Task marked as complete! Awaiting approval."),await window.fetchTasksInitial())},window.approveTask=async function(t){var e;if(!window.hasPermission("approve_task"))return void window.showNotification("You do not have permission to approve tasks","error");const n=window.tasks.find(e=>e.id===t);if(!n)return;const i={status:"completed",approvedAt:(new Date).toISOString(),approvedBy:window.currentUser},{error:o}=await window.supabase.from("tasks").update(i).eq("id",t);if(o)window.showNotification("Failed to approve task","error");else{if("cost-tracker"===n.type){const t=window.extractTotalFromTaskText(n.text)||"Unknown";window.showNotification(`Invoice approved and marked as paid! Amount: ${t}`)}else await window.updateUserPoints(n.completedBy,n.points,"add"),window.showNotification(`Task approved! ${n.points} points awarded to ${null==(e=window.users[n.completedBy])?void 0:e.displayName}`),n.isRepeating&&n.dueDate&&window.createRepeatingTask(n);await window.fetchTasksInitial()}},window.rejectTask=function(t){var e,n;if(!window.hasPermission("approve_task"))return void window.showNotification("You do not have permission to reject tasks","error");const i=window.tasks.find(e=>e.id===t);if(!i)return;const o="cost-tracker"===i.type,a=o?`Are you sure you want to deny payment for this invoice? This will apply a ${i.penaltyPoints} point penalty to ${null==(e=window.users[i.assignedTo])?void 0:e.displayName}.`:`Are you sure you want to reject this task? This will apply a ${i.penaltyPoints} point penalty to ${null==(n=window.users[i.completedBy])?void 0:n.displayName}.`;window.showConfirmModal(a,async e=>{var n;if(!e)return;const a={status:"failed",rejectedAt:(new Date).toISOString(),rejectedBy:window.currentUser},{error:s}=await window.supabase.from("tasks").update(a).eq("id",t);if(s)return void window.showNotification("Failed to reject task","error");const r=o?i.assignedTo:i.completedBy;await window.updateUserPoints(r,i.penaltyPoints,"subtract");const d=o?"Payment denied":"Task rejected";window.showNotification(`${d}! ${i.penaltyPoints} penalty points applied to ${null==(n=window.users[r])?void 0:n.displayName}`,"warning"),await window.fetchTasksInitial()})},window.deleteTask=function(t){window.hasPermission("delete_task")?window.showConfirmModal("Are you sure you want to delete this task?",async e=>{if(!e)return;const{error:n}=await window.supabase.from("tasks").delete().eq("id",t);n?window.showNotification("Failed to delete task","error"):(window.showNotification("Task deleted successfully"),await window.fetchTasksInitial())}):window.showNotification("You do not have permission to delete tasks","error")},window.acceptDemerit=async function(t){const e=window.tasks.find(e=>e.id===t);if(!e||"demerit"!==e.type)return;const n={acceptedAt:(new Date).toISOString(),status:"demerit_accepted"},{error:i}=await window.supabase.from("tasks").update(n).eq("id",t);i?window.showNotification("Failed to accept demerit","error"):(window.showNotification("Demerit accepted. You can still appeal if you believe this is unfair."),await window.fetchTasksInitial())},window.appealDemerit=function(t){const e=window.tasks.find(e=>e.id===t);e&&"demerit"===e.type&&(e.acceptedAt?window.showNotification("This demerit has already been accepted and cannot be appealed.","error"):window.showAppealModal(e,async e=>{const n={appealStatus:"pending",appealedAt:(new Date).toISOString(),appealText:e},{error:i}=await window.supabase.from("tasks").update(n).eq("id",t);i?window.showNotification("Failed to submit appeal","error"):(window.showNotification("Appeal submitted. Awaiting admin review.","warning"),await window.fetchTasksInitial())}))},window.approveAppeal=async function(t){var e;if(!window.hasPermission("approve_task"))return void window.showNotification("You do not have permission to review appeals","error");const n=window.tasks.find(e=>e.id===t);if(!n)return;const i={appealStatus:"approved",appealReviewedAt:(new Date).toISOString(),appealReviewedBy:window.currentUser},{error:o}=await window.supabase.from("tasks").update(i).eq("id",t);o?window.showNotification("Failed to approve appeal","error"):(await window.updateUserPoints(n.assignedTo,n.penaltyPoints,"add"),window.showNotification(`Appeal approved! ${n.penaltyPoints} points restored to ${null==(e=window.users[n.assignedTo])?void 0:e.displayName}`),await window.fetchTasksInitial())},window.denyAppeal=function(t){var e;if(!window.hasPermission("approve_task"))return void window.showNotification("You do not have permission to review appeals","error");const n=window.tasks.find(e=>e.id===t);n&&window.showConfirmModal(`Are you sure you want to deny this appeal? This will apply an additional ${n.penaltyPoints} point penalty to ${null==(e=window.users[n.assignedTo])?void 0:e.displayName} (double penalty).`,async e=>{var i;if(!e)return;const o={appealStatus:"denied",appealReviewedAt:(new Date).toISOString(),appealReviewedBy:window.currentUser},{error:a}=await window.supabase.from("tasks").update(o).eq("id",t);a?window.showNotification("Failed to deny appeal","error"):(window.showNotification(`Appeal denied! Additional ${n.penaltyPoints} point penalty applied to ${null==(i=window.users[n.assignedTo])?void 0:i.displayName}`,"warning"),await window.updateUserPoints(n.assignedTo,2*n.penaltyPoints,"subtract"),await window.fetchTasksInitial())})},window.createRepeatingTask=async function(t){const e=new Date(t.dueDate);switch(t.repeatInterval){case"daily":e.setDate(e.getDate()+1);break;case"weekly":e.setDate(e.getDate()+7);break;case"monthly":e.setMonth(e.getMonth()+1)}const n={text:t.text,status:"todo",type:"regular",createdAt:(new Date).toISOString(),createdBy:t.createdBy,assignedTo:"schinken",points:t.points,penaltyPoints:t.penaltyPoints,dueDate:e.toISOString(),isRepeating:!0,repeatInterval:t.repeatInterval,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1},{error:i}=await window.supabase.from("tasks").insert([n])},window.fetchSuggestionsInitial=async function(){const{data:t,error:e}=await window.supabase.from("suggestions").select("*");e?window.showError("Failed to load suggestions."):(window.suggestions=t.sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)),window.renderSuggestions())},window.rejectSuggestion=function(t){window.hasPermission("approve_suggestions")?window.showConfirmModal("Are you sure you want to reject this suggestion?",async e=>{if(!e)return;const n={status:"rejected",reviewedBy:window.currentUser,reviewedAt:(new Date).toISOString()},{error:i}=await window.supabase.from("suggestions").update(n).eq("id",t);i?window.showNotification("Failed to reject suggestion","error"):(window.showNotification("Suggestion rejected"),await window.fetchSuggestionsInitial())}):window.showNotification("You do not have permission to reject suggestions","error")},window.submitTaskSuggestion=async function(){const t=document.getElementById("suggestedTaskDescription"),e=document.getElementById("taskJustification"),n=document.getElementById("suggestedPoints"),i=document.getElementById("suggestedDueDate");if(!t||!t.value.trim())return void window.showNotification("Please enter a task description","error");const o={description:t.value.trim(),justification:e?e.value.trim():"",suggestedPoints:n&&parseInt(n.value)||10,suggestedDueDate:i&&i.value||null,suggestedBy:window.currentUser,createdAt:(new Date).toISOString(),status:"pending",reviewedBy:null,reviewedAt:null},{error:a}=await window.supabase.from("suggestions").insert([o]);if(a)window.showNotification("Failed to submit suggestion","error");else{const t=document.getElementById("suggestForm");t&&t.reset(),window.showNotification("Task suggestion submitted successfully!"),await window.fetchSuggestionsInitial()}},window.approveSuggestion=async function(t){const e=window.suggestions.find(e=>e.id===t);if(!e)return;const n={text:e.description,status:"todo",type:"regular",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:e.suggestedPoints,penaltyPoints:Math.floor(e.suggestedPoints/2),dueDate:e.suggestedDueDate,isRepeating:!1,repeatInterval:null,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1},i={status:"approved",reviewedBy:window.currentUser,reviewedAt:(new Date).toISOString()},{error:o}=await window.supabase.from("tasks").insert([n]),{error:a}=await window.supabase.from("suggestions").update(i).eq("id",t);o||a?window.showNotification("Failed to approve suggestion","error"):(window.showNotification("Suggestion approved and converted to task!"),await window.fetchTasksInitial(),await window.fetchSuggestionsInitial())},window.addReward=async function(t,e,n,i){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to add rewards","error");const{error:o}=await window.supabase.from("rewards").insert([{title:t,description:e,cost:n,type:i,createdAt:(new Date).toISOString(),createdBy:window.currentUser,lastUpdatedAt:(new Date).toISOString()}]);o?window.showNotification("Failed to add reward.","error"):(window.showNotification("Reward added successfully!"),await window.fetchRewardsInitial())},window.updateReward=async function(t,e,n,i,o){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to update rewards","error");const{error:a}=await window.supabase.from("rewards").update({title:e,description:n,cost:i,type:o,lastUpdatedAt:(new Date).toISOString()}).eq("id",t);a?window.showNotification("Failed to update reward.","error"):(window.showNotification("Reward updated successfully!"),await window.fetchRewardsInitial())},window.deleteReward=async function(t){window.hasPermission("manage_rewards")?window.showConfirmModal("Are you sure you want to delete this reward?",async e=>{if(!e)return;const{error:n}=await window.supabase.from("rewards").delete().eq("id",t);n?window.showNotification("Failed to delete reward.","error"):(window.showNotification("Reward deleted successfully!"),await window.fetchRewardsInitial())}):window.showNotification("You do not have permission to delete rewards","error")},window.purchaseReward=async function(t){const e=window.rewards.find(e=>e.id===t);if(!e)return void window.showNotification("Reward not found.","error");if(window.users[window.currentUser].points<e.cost)return void window.showNotification("Not enough points to purchase this reward.","error");let n="purchased",i=!1;const o=window.rewardSystemSettings,a=o.currentInstantSpend||0,s=o.instantPurchaseLimit||0,r=!1!==o.requiresAuthorizationAfterLimit;"instant"===e.type?r&&a+e.cost>s&&(i=!0,n="pending_authorization"):(i=!0,n="pending_authorization"),window.showConfirmModal(`Are you sure you want to purchase "${e.title}" for ${e.cost} points?`+(i?" This purchase will require admin authorization.":""),async t=>{if(!t)return;await window.updateUserPoints(window.currentUser,e.cost,"subtract");const{error:o}=await window.supabase.from("userRewardPurchases").insert([{userId:window.currentUser,rewardId:e.id,purchaseCost:e.cost,purchaseDate:(new Date).toISOString(),status:n}]);if(o)return window.showNotification("Failed to record purchase. Points were refunded.","error"),void(await window.updateUserPoints(window.currentUser,e.cost,"add"));if("instant"===e.type&&!i){const{error:t}=await window.supabase.from("rewardSystemSettings").upsert({id:"system_settings",currentInstantSpend:a+e.cost},{onConflict:"id",ignoreDuplicates:!1});t?window.showNotification("Error updating instant spend limit.","warning"):window.rewardSystemSettings.currentInstantSpend=a+e.cost}window.showNotification(`"${e.title}" ${i?"purchase submitted for authorization.":"purchased instantly!"}`),await window.fetchRewardsInitial(),await window.fetchUserRewardPurchasesInitial(),await window.fetchRewardSystemSettingsInitial()})},window.authorizePurchase=async function(t){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to authorize purchases","error");const e=window.userRewardPurchases.find(e=>e.id===t);if(!e)return;const{error:n}=await window.supabase.from("userRewardPurchases").update({status:"authorized",authorizedBy:window.currentUser,authorizedAt:(new Date).toISOString()}).eq("id",t);n?window.showNotification("Failed to authorize purchase.","error"):(window.showNotification(`Purchase of "${e.rewards.title}" authorized for ${e.userId}.`),await window.fetchUserRewardPurchasesInitial())},window.denyPurchase=function(t){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to deny purchases","error");const e=window.userRewardPurchases.find(e=>e.id===t);e&&window.showConfirmModal(`Are you sure you want to deny the purchase of "${e.rewards.title}" by ${e.userId}? Points will be refunded.`,async n=>{if(!n)return;const{error:i}=await window.supabase.from("userRewardPurchases").update({status:"denied",authorizedBy:window.currentUser,authorizedAt:(new Date).toISOString(),notes:"Denied by admin."}).eq("id",t);i?window.showNotification("Failed to deny purchase.","error"):(await window.updateUserPoints(e.userId,e.purchaseCost,"add"),window.showNotification(`Purchase denied. ${e.purchaseCost} points refunded to ${e.userId}.`,"warning"),await window.fetchUserRewardPurchasesInitial())})},window.resetInstantPurchaseLimit=async function(){window.hasPermission("manage_rewards")?window.showConfirmModal("Are you sure you want to reset the instant purchase spend to 0?",async t=>{if(!t)return;const{error:e}=await window.supabase.from("rewardSystemSettings").upsert({id:"system_settings",currentInstantSpend:0,lastResetAt:(new Date).toISOString()},{onConflict:"id"});e?window.showNotification("Failed to reset instant purchase limit.","error"):(window.showNotification("Instant purchase limit reset successfully!"),window.rewardSystemSettings.currentInstantSpend=0,window.rewardSystemSettings.lastResetAt=(new Date).toISOString(),await window.fetchRewardSystemSettingsInitial())}):window.showNotification("You do not have permission to reset the limit","error")},window.updateRewardSystemSettings=async function(t,e,n){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to update reward settings","error");const{error:i}=await window.supabase.from("rewardSystemSettings").upsert({id:"system_settings",instantPurchaseLimit:t,resetDurationDays:e,requiresAuthorizationAfterLimit:n,lastUpdatedAt:(new Date).toISOString()},{onConflict:"id"});i?window.showNotification("Failed to update reward settings.","error"):(window.showNotification("Reward settings updated successfully!"),await window.fetchRewardSystemSettingsInitial())},window.checkForRewardLimitReset=async function(){const t=window.rewardSystemSettings;if(t.resetDurationDays>0&&t.lastResetAt){const e=new Date(t.lastResetAt),n=new Date(e);n.setDate(e.getDate()+t.resetDurationDays),new Date>=n&&(await window.resetInstantPurchaseLimit(),window.showNotification("Instant purchase limit automatically reset!","info"))}},window.fetchRewardsInitial=async function(){const{data:t,error:e}=await window.supabase.from("rewards").select("*");e?window.showError("Failed to load rewards."):(window.rewards=t.sort((t,e)=>t.title.localeCompare(e.title)),"shop"!==window.activeTab&&"skeen"!==window.currentUser||(window.renderRewards(),"skeen"===window.currentUser&&window.renderAdminRewardManagement()))},window.fetchUserRewardPurchasesInitial=async function(){const t="skeen"===window.currentUser?window.supabase.from("userRewardPurchases").select("*, rewards(title, cost, type)").order("purchaseDate",{ascending:!1}):window.supabase.from("userRewardPurchases").select("*, rewards(title, cost, type)").eq("userId",window.currentUser).order("purchaseDate",{ascending:!1}),{data:e,error:n}=await t;n?window.showError("Failed to load purchase history."):(window.userRewardPurchases=e,"shop"!==window.activeTab&&"skeen"!==window.currentUser||(window.renderUserRewardPurchases(),"skeen"===window.currentUser&&window.renderPendingAuthorizations()))},window.fetchRewardSystemSettingsInitial=async function(){const{data:t,error:e}=await window.supabase.from("rewardSystemSettings").select("*").eq("id","system_settings").limit(1);e?(window.rewardSystemSettings={id:"system_settings",instantPurchaseLimit:500,currentInstantSpend:0,resetDurationDays:30,lastResetAt:(new Date).toISOString(),requiresAuthorizationAfterLimit:!0},await window.supabase.from("rewardSystemSettings").upsert([window.rewardSystemSettings],{onConflict:"id"})):t&&t.length>0?(window.rewardSystemSettings=t[0],window.checkForRewardLimitReset()):(window.rewardSystemSettings={id:"system_settings",instantPurchaseLimit:500,currentInstantSpend:0,resetDurationDays:30,lastResetAt:(new Date).toISOString(),requiresAuthorizationAfterLimit:!0},await window.supabase.from("rewardSystemSettings").upsert([window.rewardSystemSettings],{onConflict:"id"})),"skeen"!==window.currentUser||"dashboard"!==window.activeTab&&"adminSettings"!==window.activeTab||(window.renderDashboard(),window.renderAdminRewardSettings())};let e=0;function n(t){switch(t){case 1e3:return"second";case 6e4:return"minute";case 36e5:return"hour";default:return"unit"}}window.logUserActivity=async function(t){if("schinken"!==window.currentUser&&"skeen"!==window.currentUser)return;if("login"===t){const t=Date.now();if(t-e<5e3)return;e=t}const n={user:window.currentUser,action:t,timestamp:(new Date).toISOString()};if(window.userActivityLog.unshift(n),window.userActivityLog.length>50&&(window.userActivityLog=window.userActivityLog.slice(0,50)),window.supabase){const{error:t}=await window.supabase.from("userActivity").insert([n]);t&&window.userActivityLog.shift()}},window.fetchUserActivityInitial=async function(){const{data:t,error:e}=await window.supabase.from("userActivity").select("*").order("timestamp",{ascending:!1}).limit(50);e||(window.userActivityLog=t,window.renderDashboard())},window.fetchUserProfilesInitial=async function(){const{data:t,error:e}=await window.supabase.from("userProfiles").select("*");e||(t.forEach(t=>{const e=t.username;window.users[e]&&(window.users[e].points=t.points||0)}),window.updateUserPoints(),window.renderUserProgress())},window.updateUserPoints=async function(t=window.currentUser,e=0,n=null){if("skeen"===t){("set"===n||"add"===n||"subtract"===n)&&(window.users[t].points=0);const e=document.getElementById("userPoints");e&&(e.textContent="0 Points");const i=document.getElementById("myPointsStat");return void(i&&(i.textContent=0))}var i=window.users[t].points||0;if("set"===n)window.users[t].points=e;else if("add"===n)window.users[t].points=i+e;else if("subtract"===n){window.users[t].points=i-e;var o=window.users[t].points;i>=0&&o<0&&t===window.currentUser&&window.showNotification(`⚠️ Your points are now negative: ${o} points! Complete tasks to get back to positive.`,"warning")}if(null!==n&&window.supabase){const{error:e}=await window.supabase.from("userProfiles").upsert({username:t,points:window.users[t].points,updatedAt:(new Date).toISOString()},{onConflict:"username"})}if(t===window.currentUser){const t=document.getElementById("userPoints");if(t){const e=window.users[window.currentUser].points||0;let n="#00ff00";e<0?n="#ff6b6b":0===e&&(n="#ffff00"),t.textContent=`${e} Points`,t.style.color=n}const e=document.getElementById("myPointsStat");if(e){const t=window.users[window.currentUser].points||0;e.textContent=t,e.style.color=t<0?"#ff6b6b":0===t?"#ffff00":"#00ff00"}}"schinken"===t&&window.updateAdminPointsDisplay&&window.updateAdminPointsDisplay(),window.updateStats&&window.updateStats(),window.renderUserProgress&&window.renderUserProgress()},window.setUserPoints=async function(){if(!window.hasPermission("manage_users"))return void window.showNotification("You do not have permission to manage user points","error");const t=document.getElementById("adminPointsInput"),e=parseInt(t.value);if(isNaN(e))return void window.showNotification("Please enter a valid number","error");const n=window.users.schinken.points||0;await window.updateUserPoints("schinken",e,"set"),window.showNotification(`User points changed from ${n} to ${e}`,"success");try{const t={user:window.currentUser,action:"points_changed",details:`Changed schinken points from ${n} to ${e}`,timestamp:(new Date).toISOString()};await window.supabase.from("userActivity").insert([t])}catch(i){}},window.fetchActiveCostTrackersInitial=async function(){const{data:t,error:e}=await window.supabase.from("active_cost_trackers").select("*").eq("status","running");e?window.showError("Failed to load active cost trackers."):(window.activeCostTrackers=t.sort((t,e)=>new Date(e.started_at)-new Date(t.started_at)),"skeen"===window.currentUser?(window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount()):"schinken"===window.currentUser&&window.updateLiveCostTracker())},window.stopAllActiveCostTrackers=async function(){if(!window.hasPermission("create_task"))return;const{data:t,error:e}=await window.supabase.from("active_cost_trackers").select("*").eq("status","running");if(!e&&t&&t.length>0){const{error:t}=await window.supabase.from("active_cost_trackers").update({status:"stopped",updated_at:(new Date).toISOString()}).eq("status","running")}},window.startLiveCostTracker=async function(t,e,n,i,o=[]){if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to start cost trackers","error");await window.stopAllActiveCostTrackers();const a={created_by:window.currentUser,started_at:(new Date).toISOString(),description:t||"Cost Tracker Running",rate:e||50,currency:n||"€",increment_interval:i||6e4,penalties:JSON.stringify(o),status:"running"},{data:s,error:r}=await window.supabase.from("active_cost_trackers").insert([a]).select().single();if(!r)return window.showNotification("Live cost tracker started successfully!"),window.activeLiveTrackerId=s.id,await window.fetchActiveCostTrackersInitial(),s.id;window.showNotification("Failed to start cost tracker.","error")},window.stopLiveCostTracker=async function(t,e=!0){if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to stop cost trackers","error");const{data:n,error:i}=await window.supabase.from("active_cost_trackers").select("*").eq("id",t).single();if(i)return void window.showNotification(`Failed to find cost tracker: ${i.message}`,"error");if(!n)return void window.showNotification("Cost tracker not found in database","error");const{error:o}=await window.supabase.from("active_cost_trackers").update({status:"stopped",updated_at:(new Date).toISOString()}).eq("id",t);if(o)window.showNotification(`Failed to stop cost tracker: ${o.message}`,"error");else{if(e)try{const t=new Date(n.started_at),e=new Date-t,i=e/n.increment_interval*n.rate;let o=[];try{o=JSON.parse(n.penalties||"[]")}catch(a){o=[]}const s=i+o.reduce((t,e)=>t+(e.amount||0),0),r=Math.floor(e/36e5),d=Math.floor(e%36e5/6e4),c=Math.floor(e%6e4/1e3),l=r>0?`${r}h ${d}m ${c}s`:d>0?`${d}m ${c}s`:`${c}s`,w=1e3===n.increment_interval?"second":6e4===n.increment_interval?"minute":"hour";let u=`💰 INVOICE - ${n.description}\n\nTime-based Cost: ${l} @ ${n.currency}${n.rate.toFixed(2)} per ${w} = ${n.currency}${i.toFixed(2)}`;o.length>0&&(u+="\n\nAdditional Costs:\n"+o.map(t=>`• ${t.description}: ${n.currency}${(t.amount||0).toFixed(2)}`).join("\n")),u+=`\n\n💸 TOTAL AMOUNT DUE: ${n.currency}${s.toFixed(2)}\n\n⚠️ This is an invoice that must be approved for payment. Failure to approve will result in penalty points.`;const p={text:u,status:"todo",type:"cost-tracker",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:"schinken",points:0,penaltyPoints:100,dueDate:new Date(Date.now()+6048e5).toISOString(),isRepeating:!1,repeatInterval:null},{error:m}=await window.supabase.from("tasks").insert([p]);m?window.showNotification("Tracker stopped but failed to create invoice.","warning"):(window.showNotification(`Cost tracker stopped and invoice created! Total: ${n.currency}${s.toFixed(2)}`),await window.fetchTasksInitial())}catch(s){window.showNotification("Tracker stopped but invoice creation failed","warning")}else window.showNotification("Cost tracker stopped.");window.activeLiveTrackerId===t&&(window.activeLiveTrackerId=null),window.currentLiveTracker&&window.currentLiveTracker.id===t&&(window.currentLiveTracker=null),await window.fetchActiveCostTrackersInitial()}},window.addPenaltyToLiveTracker=async function(t,e,n){if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to modify cost trackers","error");const{data:i,error:o}=await window.supabase.from("active_cost_trackers").select("penalties").eq("id",t).single();if(o)return;const a=JSON.parse(i.penalties||"[]");a.push({id:Date.now(),description:e,amount:n,added_at:(new Date).toISOString()});const{error:s}=await window.supabase.from("active_cost_trackers").update({penalties:JSON.stringify(a),updated_at:(new Date).toISOString()}).eq("id",t);s?window.showNotification("Failed to add penalty.","error"):(window.showNotification(`Penalty added: ${e} (${n})`),await window.fetchActiveCostTrackersInitial())},window.removePenaltyFromLiveTracker=async function(t,e){if(!window.hasPermission("create_task"))return void window.showNotification("You do not have permission to modify cost trackers","error");const{data:n,error:i}=await window.supabase.from("active_cost_trackers").select("penalties").eq("id",t).single();if(i)return;const o=JSON.parse(n.penalties||"[]").filter(t=>t.id!==e),{error:a}=await window.supabase.from("active_cost_trackers").update({penalties:JSON.stringify(o),updated_at:(new Date).toISOString()}).eq("id",t);a?window.showNotification("Failed to remove penalty.","error"):(window.showNotification("Penalty removed."),await window.fetchActiveCostTrackersInitial())},window.fullCalendarInstance=null,window.refreshButtonStates={},window.setupRefreshButton=function(t,e){var n=document.getElementById(t);if(n){window.refreshButtonStates[t]||(window.refreshButtonStates[t]={lastClickTime:0,cooldownTimerId:null,originalText:n.textContent});var i=window.refreshButtonStates[t],o=function(){var t=Date.now()-i.lastClickTime,a=1e3*e-t;if(a>0){n.disabled=!0;var s=Math.ceil(a/1e3);n.textContent="Refreshing ("+s+"s)",i.cooldownTimerId&&clearTimeout(i.cooldownTimerId),i.cooldownTimerId=setTimeout(o,1e3)}else n.disabled=!1,n.textContent=i.originalText,i.cooldownTimerId&&(clearTimeout(i.cooldownTimerId),i.cooldownTimerId=null)};o(),n.onclick=function(){var t=Date.now(),a=t-i.lastClickTime;a<1e3*e?window.showNotification("Please wait "+Math.ceil((1e3*e-a)/1e3)+" seconds before refreshing again.","warning"):(i.lastClickTime=t,n.disabled=!0,n.textContent="Refreshing...",window.showNotification("Refreshing data...","info"),window.loadData&&"function"==typeof window.loadData?window.loadData().then(function(){window.showNotification("Data refreshed successfully!","success"),o()}).catch(function(t){window.showNotification("Failed to refresh data.","error"),o()}):(window.showNotification("Refresh function not available.","warning"),o()))}}},window.switchTab=function(t){window.hideSpiralGenerator(),window.hideCostTracker();for(var e=document.querySelectorAll(".nav-tab"),n=0;n<e.length;n++)e[n].classList.remove("active");var i=Array.from(document.querySelectorAll(".nav-tab")).find(function(e){return-1!==e.textContent.toLowerCase().indexOf(t.toLowerCase())});i&&i.classList.add("active");var o=document.querySelectorAll(".tab-content");for(n=0;n<o.length;n++)o[n].classList.remove("active");var a=document.getElementById(t+"View");if(a&&a.classList.add("active"),window.activeTab=t,"schinken"!==window.currentUser&&window.clearLiveCostTrackerIntervals(),"calendar"===t)window.renderCalendar();else if("dashboard"===t&&window.hasPermission("view_dashboard"))window.renderDashboard();else if("suggest"===t)window.renderMySuggestions();else if("shop"===t)window.renderRewards(),window.renderUserRewardPurchases();else if("adminSettings"===t)if("skeen"===window.currentUser&&window.hasPermission("manage_rewards"))window.renderAdminRewardManagement(),window.renderPendingAuthorizations(),window.renderAdminRewardSettings();else{const t=document.getElementById("adminRewardManagement");t&&(t.style.display="none")}else"tasks"===t&&"skeen"===window.currentUser&&window.renderTasks()},window.showLogin=function(){document.getElementById("loginScreen").style.display="block",document.getElementById("mainApp").style.display="none"},window.showMainApp=async function(){document.getElementById("loginScreen").style.display="none",document.getElementById("mainApp").style.display="block";var t=window.users[window.currentUser];document.getElementById("userBadge").textContent=t.displayName;var e=document.getElementById("userPoints");e&&(e.style.display="skeen"===t.role?"none":"inline-block"),window.logUserActivity("login");var n=document.getElementById("dashboardTab"),i=document.getElementById("suggestTab"),o=document.getElementById("shopTab"),a=document.getElementById("adminSettingsTab"),s=document.getElementById("adminView"),r=document.getElementById("userView"),d=document.getElementById("adminRewardManagement");"skeen"===window.currentUser?(n&&(n.style.display="block"),i&&(i.style.display="none"),o&&(o.style.display="none"),a&&(a.style.display=window.hasPermission("manage_rewards")?"block":"none"),s&&(s.style.display="block"),r&&(r.style.display="none"),d&&(d.style.display=window.hasPermission("manage_rewards")?"block":"none")):(n&&(n.style.display="none"),i&&(i.style.display="block"),o&&(o.style.display="block"),a&&(a.style.display="none"),s&&(s.style.display="none"),r&&(r.style.display="block"),d&&(d.style.display="none")),window.initializeToolButtons();var c=document.getElementById("isRepeating");c&&c.addEventListener("change",function(){var t=document.getElementById("repeatOptions");t&&(t.style.display=this.checked?"block":"none")});var l=document.getElementById("isDemerit");l&&l.addEventListener("change",function(){var t=document.getElementById("demeritWarning");t&&(t.style.display=this.checked?"block":"none");var e=document.getElementById("taskPoints"),n=document.getElementById("penaltyPoints"),i=document.getElementById("taskDueDate");this.checked?(e&&(e.closest(".form-group").style.display="none"),i&&(i.closest(".form-group").style.display="none"),n&&(n.closest(".form-group").style.display="block")):(e&&(e.closest(".form-group").style.display="block"),i&&(i.closest(".form-group").style.display="block"),n&&(n.closest(".form-group").style.display="block"))}),window.loadData&&"function"==typeof window.loadData?await window.loadData().then(function(){window.updateUserPoints&&"function"==typeof window.updateUserPoints&&window.updateUserPoints(),window.renderCalendar(),window.overdueCheckIntervalId&&clearInterval(window.overdueCheckIntervalId),window.checkForOverdueTasks&&window.OVERDUE_CHECK_INTERVAL&&(window.overdueCheckIntervalId=setInterval(window.checkForOverdueTasks,window.OVERDUE_CHECK_INTERVAL)),"skeen"===window.currentUser&&window.hasPermission("manage_rewards")?(window.renderAdminRewardManagement(),window.renderPendingAuthorizations(),window.renderAdminRewardSettings()):"skeen"!==window.currentUser&&(window.renderRewards(),window.renderUserRewardPurchases()),"skeen"===window.currentUser&&window.renderTasks()}).catch(function(t){window.showNotification("Failed to load data.","error")}):window.renderCalendar()},window.renderTasks=function(){"skeen"===window.users[window.currentUser].role?window.renderAdminView():window.renderUserView()},window.renderAdminView=function(){var t=window.tasks.filter(function(t){return"demerit"===t.type&&"pending"===t.appealStatus}),e=document.getElementById("pendingAppeals");e&&(0===t.length?e.innerHTML='<div class="empty-state">No appeals pending review</div>':e.innerHTML=t.map(function(t){return'<div class="task-item appeal-pending"><div class="task-content"><div><span class="status-badge status-pending">Appeal Pending</span><span class="task-text">'+window.escapeHtml(t.text)+'</span><span class="points-badge-small">-'+t.penaltyPoints+" pts (risk: -"+2*t.penaltyPoints+')</span><div class="task-meta">User: '+(window.users[t.assignedTo]?window.users[t.assignedTo].displayName:t.assignedTo)+"<br>Appealed: "+window.formatDate(t.appealedAt)+"<br>Original demerit: "+window.formatDate(t.createdAt)+(t.acceptedAt?"<br>Accepted: "+window.formatDate(t.acceptedAt):"<br>Status: Not accepted")+(t.appealText?"<br>Appeal Reason: "+window.escapeHtml(t.appealText):"")+'</div></div><div class="task-actions"><button class="action-btn approve-btn" onclick="approveAppeal('+t.id+')">Approve Appeal</button><button class="action-btn reject-btn" onclick="denyAppeal('+t.id+')">Deny Appeal (Double Penalty)</button></div></div></div>'}).join("")),window.renderAdminSuggestions();var n=window.tasks.filter(function(t){return"pending_approval"===t.status&&"demerit"!==t.type}),i=document.getElementById("pendingTasks");i&&(0===n.length?i.innerHTML='<div class="empty-state">No tasks pending approval</div>':i.innerHTML=n.map(function(t){var e="";if("cost-tracker"===(t.type||"regular")){const n=window.extractTotalFromTaskText(t.text)||"N/A";e=`\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="status-badge status-pending">Invoice Payment ${"pending_approval"===t.status?"Pending Admin Approval":"Required"}</span>\n\t\t\t\t\t\t\t\t<span class="task-text">💰 ${window.escapeHtml(t.text.split("\n")[0])}</span>\n\t\t\t\t\t\t\t\t<span class="points-badge-small cost-badge">${n}</span>\n\t\t\t\t\t\t\t\t<div class="task-meta">\n\t\t\t\t\t\t\t\t\t<strong>Invoice Details:</strong><br>\n\t\t\t\t\t\t\t\t\tTotal Amount: ${n}<br>\n\t\t\t\t\t\t\t\t\tPenalty if not paid: -100 points<br>\n\t\t\t\t\t\t\t\t\t${t.dueDate?"Payment Due: "+window.formatDate(t.dueDate)+"<br>":""}\n\t\t\t\t\t\t\t\t\t${"pending_approval"===t.status?"User marked as paid: "+window.formatDate(t.completedAt)+"<br>":""}\n\t\t\t\t\t\t\t\t\tCreated by: ${window.users[t.createdBy]?window.users[t.createdBy].displayName:t.createdBy}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="task-actions">\n\t\t\t\t\t\t\t\t<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Invoice</button>\n\t\t\t\t\t\t\t\t${"pending_approval"===t.status?`\n\t\t\t\t\t\t\t\t\t<button class="action-btn approve-btn" onclick="window.approveInvoice(${t.id})">Approve Payment</button>\n\t\t\t\t\t\t\t\t\t<button class="action-btn reject-btn" onclick="rejectTask(${t.id})">Deny Payment</button>\n\t\t\t\t\t\t\t\t`:""}\n\t\t\t\t\t\t\t\t<button class="action-btn delete-btn" onclick="deleteTask(${t.id})">Delete</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`}else e=`\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<span class="status-badge status-pending">Pending Approval</span>\n\t\t\t\t\t\t\t\t<span class="task-text">${window.escapeHtml(t.text)}</span>\n\t\t\t\t\t\t\t\t<span class="points-badge-small">+${t.points} pts</span>\n\t\t\t\t\t\t\t\t<div class="task-meta">\n\t\t\t\t\t\t\t\t\tCompleted by: ${window.users[t.completedBy]?window.users[t.completedBy].displayName:t.completedBy}\n\t\t\t\t\t\t\t\t\t${t.dueDate?"<br>Due: "+window.formatDate(t.dueDate):""}\n\t\t\t\t\t\t\t\t\t${t.isRepeating?"<br>売 Repeating":""}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="task-actions">\n\t\t\t\t\t\t\t\t<button class="action-btn approve-btn" onclick="approveTask(${t.id})">Approve</button>\n\t\t\t\t\t\t\t\t<button class="action-btn reject-btn" onclick="rejectTask(${t.id})">Reject & Penalize</button>\n\t\t\t\t\t\t\t\t<button class="action-btn delete-btn" onclick="deleteTask(${t.id})">Delete</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`;return`<div class="task-item pending-approval ${t.isOverdue?"overdue":""}"><div class="task-content">${e}</div></div>`}).join(""));var o=document.getElementById("allTasksAdmin");o&&(0===window.tasks.length?o.innerHTML='<div class="empty-state">No tasks created yet</div>':o.innerHTML=window.tasks.map(function(t){var e="";"completed"===t.status&&(e+="completed "),t.isOverdue&&(e+="overdue "),"demerit"===t.type&&(e+="demerit-task "),"spiral"===t.type&&(e+="spiral-task "),"cost-tracker"===t.type&&(e+="cost-tracker-task ");const n="cost-tracker"===t.type?window.extractTotalFromTaskText(t.text):null;return'<div class="task-item '+e+'"><div class="task-content"><div><span class="status-badge '+window.getStatusClass(t.status,t.isOverdue,t.type,t.appealStatus)+'">'+window.getStatusText(t.status,t.isOverdue,t.type,t.appealStatus)+'</span><span class="task-text">'+window.escapeHtml(t.text.split("\n")[0])+"</span>"+("cost-tracker"===t.type&&n?'<span class="points-badge-small cost-badge">'+n+"</span>":"")+("regular"===t.type?'<span class="points-badge-small">+'+t.points+" pts</span>":"")+("demerit"===t.type?'<span class="points-badge-small">-'+t.penaltyPoints+" pts</span>":"")+("cost-tracker"===t.type?'<span class="points-badge-small">-100 pts penalty</span>':"")+("demerit"===t.type&&t.appealStatus?'<span class="points-badge-small appeal-status '+t.appealStatus+'">'+t.appealStatus+"</span>":"")+("demerit"===t.type&&t.acceptedAt?'<span class="points-badge-small" style="background: #e0e7ff; color: #3730a3;">Accepted</span>':"")+'<div class="task-meta">Assigned to: '+(window.users[t.assignedTo]?window.users[t.assignedTo].displayName:t.assignedTo)+(t.completedBy?"<br>Completed by: "+(window.users[t.completedBy]?window.users[t.completedBy].displayName:t.completedBy):"")+(t.dueDate?"<br>Due: "+window.formatDate(t.dueDate):"")+(t.isRepeating?"<br>🔄 Repeating":"")+("demerit"===t.type?"<br>⚠️ Demerit Task":"")+("spiral"===t.type?"<br>🌀 Spiral Task":"")+("cost-tracker"===t.type?"<br>💰 Invoice":"")+(t.completedAt?"<br>Completed: "+window.formatDate(t.completedAt):"")+(t.approvedBy?"<br>Approved: "+window.formatDate(t.approvedBy):"")+(t.rejectedBy?"<br>Rejected: "+window.formatDate(t.rejectedBy):"")+(t.acceptedAt?"<br>Accepted: "+window.formatDate(t.acceptedAt):"")+(t.appealedAt?"<br>Appealed: "+window.formatDate(t.appealedAt):"")+(t.appealReviewedAt?"<br>Reviewed: "+window.formatDate(t.appealReviewedAt)+" by "+(window.users[t.appealReviewedBy]?window.users[t.appealReviewedBy].displayName:t.appealReviewedBy):"")+(t.appealText?"<br>Appeal Reason: "+window.escapeHtml(t.appealText):"")+'</div></div><div class="task-actions"><button class="action-btn delete-btn" onclick="deleteTask('+t.id+')">Delete</button></div></div></div>'}).join("")),setTimeout(function(){window.setupRefreshButton("refreshDataBtnAdmin",30)},0)},window.renderUserView=function(){var t=window.tasks.filter(function(t){return t.assignedTo===window.currentUser}),e=document.getElementById("myTasks");e&&(0===t.length?e.innerHTML='<div class="empty-state">No tasks available</div>':e.innerHTML=t.map(function(t){var e="";"demerit"===t.type&&(e+="demerit-task-user "),t.isOverdue&&(e+="overdue "),"completed"===t.status&&(e+="completed "),"pending_approval"===t.status&&(e+="pending-approval "),"pending"===t.appealStatus&&(e+="appeal-pending "),"spiral"===t.type&&(e+="spiral-task-user "),"cost-tracker"===t.type&&(e+="cost-tracker-task-user ");var n="",i=window.escapeHtml(t.text);"spiral"===t.type?n=`<button class="action-btn check-btn" onclick="window.viewSpiralTask(${t.id})">View Spiral</button>`:"cost-tracker"===t.type?n="todo"===t.status?`<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Invoice</button>\n\t\t\t\t\t\t\t\t\t\t\t<button class="action-btn approve-btn" onclick="window.markInvoiceAsPaid(${t.id})">Mark as Paid</button>`:"pending_approval"===t.status?`<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Invoice</button>\n\t\t\t\t\t\t\t\t\t\t\t<span style="color: #fcd34d; font-weight: bold;">⏳ Payment Pending Admin Approval</span>`:"completed"===t.status?`<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Paid Invoice</button>`:"failed"===t.status?`<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Denied Invoice</button>\n\t\t\t\t\t\t\t\t\t\t\t<span style="color: #f87171; font-weight: bold;">❌ Payment Denied</span>`:`<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${t.id})">View Invoice</button>`:"regular"!==t.type||"todo"!==t.status||t.isOverdue?"regular"===t.type&&t.isOverdue&&"todo"===t.status?n=`<button class="action-btn check-btn" onclick="checkOffTask(${t.id})">Mark Complete (Overdue)</button>`:"demerit"!==t.type||t.acceptedAt||t.appealStatus||(n=`<button class="action-btn accept-btn" onclick="acceptDemerit(${t.id})">Accept Demerit</button>\n\t\t\t\t\t\t\t\t\t\t <button class="action-btn appeal-btn" onclick="appealDemerit(${t.id})">Appeal Demerit</button>`):n=`<button class="action-btn check-btn" onclick="checkOffTask(${t.id})">Mark Complete</button>`;const o="cost-tracker"===t.type?window.extractTotalFromTaskText(t.text):null;return t.isRepeating&&"todo"===t.status&&(n+=`<button class="action-btn check-btn" onclick="checkOffTask(${t.id})">Mark Complete</button>`),'<div class="task-item '+e+'"><div class="task-content"><div><span class="status-badge '+window.getStatusClass(t.status,t.isOverdue,t.type,t.appealStatus)+'">'+window.getStatusText(t.status,t.isOverdue,t.type,t.appealStatus)+'</span><span class="task-text">'+("cost-tracker"===t.type?"💰 ":"")+("cost-tracker"===t.type?window.escapeHtml(t.text.split("\n")[0]):i)+"</span>"+("cost-tracker"===t.type&&o?'<span class="points-badge-small cost-badge">'+o+"</span>":"")+("regular"===t.type?'<span class="points-badge-small">+'+t.points+" pts</span>":"")+("demerit"===t.type?'<span class="points-badge-small">-'+t.penaltyPoints+" pts</span>":"")+("cost-tracker"===t.type?'<span class="points-badge-small">-100 pts penalty</span>':"")+("demerit"===t.type&&t.appealStatus?'<span class="points-badge-small appeal-status '+t.appealStatus+'">'+t.appealStatus+"</span>":"")+("demerit"===t.type&&t.acceptedAt?'<span class="points-badge-small" style="background: #e0e7ff; color: #3730a3;">Accepted</span>':"")+'<div class="task-meta">'+("demerit"===t.type?"Issued by: "+(window.users[t.createdBy]?window.users[t.createdBy].displayName:t.createdBy):"cost-tracker"===t.type?"Invoice from: "+(window.users[t.createdBy]?window.users[t.createdBy].displayName:t.createdBy):"Created by: "+(window.users[t.createdBy]?window.users[t.createdBy].displayName:t.createdBy))+(t.dueDate?"<br>"+("cost-tracker"===t.type?"Payment Due: ":"Due: ")+window.formatDate(t.dueDate):"")+(t.isRepeating?"<br>🔄 Repeating":"")+("demerit"===t.type?"<br>⚠️ Demerit Task":"")+("spiral"===t.type?"<br>🌀 Spiral Task":"")+("cost-tracker"===t.type?"<br>💰 Invoice - "+("pending_approval"===t.status?"Payment Required":"completed"===t.status?"Paid":"Invoice"):"")+(t.completedBy?"<br>Completed by: "+(window.users[t.completedBy]?window.users[t.completedBy].displayName:t.completedBy):"")+(t.approvedBy?"<br>Approved by: "+(window.users[t.approvedBy]?window.users[t.approvedBy].displayName:t.approvedBy):"")+(t.rejectedBy?"<br>Rejected by: "+(window.users[t.rejectedBy]?window.users[t.rejectedBy].displayName:t.rejectedBy):"")+(t.acceptedAt?"<br>Accepted: "+window.formatDate(t.acceptedAt):"")+(t.appealedAt?"<br>Appealed: "+window.formatDate(t.appealedAt):"")+(t.appealReviewedAt?"<br>Reviewed: "+window.formatDate(t.appealReviewedAt)+" by "+(window.users[t.appealReviewedBy]?window.users[t.appealReviewedBy].displayName:t.appealReviewedBy):"")+(t.appealText?"<br>Appeal Reason: "+window.escapeHtml(t.appealText):"")+'</div></div><div class="task-actions">'+n+"</div></div></div>"}).join("")),setTimeout(function(){window.setupRefreshButton("refreshDataBtnUser",30)},0)},window.viewSpiralTask=function(t){const e=window.tasks.find(e=>e.id===t);if(!e||"spiral"!==e.type)return void window.showNotification("This is not a spiral task.","error");const n=document.getElementById("spiralModal");if(n){n.classList.remove("hidden"),window.spiral&&window.spiral.init?setTimeout(()=>{window.spiral.init();const t=e.spiralConfig||e.spiralconfig;t?window.spiral.applyConfiguration(t):window.spiral.initDefaultText();const n=document.getElementById("controls");if(n&&"skeen"!==window.currentUser){n.style.display="none";const t=document.createElement("div");t.style.cssText="\n\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\ttop: 60px;\n\t\t\t\t\t\tright: 20px;\n\t\t\t\t\t\tbackground: var(--terminal-bg);\n\t\t\t\t\t\tborder: 1px solid var(--terminal-green);\n\t\t\t\t\t\tcolor: var(--terminal-green);\n\t\t\t\t\t\tpadding: 15px;\n\t\t\t\t\t\tz-index: 1001;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\tborder-radius: 0;\n\t\t\t\t\t",t.textContent="👁️ View-Only Mode - Enjoy the spiral!",t.id="spiralViewNotice",document.body.appendChild(t)}else if(n){n.style.display="block";const t=document.createElement("div");t.style.cssText="\n\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\ttop: 60px;\n\t\t\t\t\t\tright: 20px;\n\t\t\t\t\t\tbackground: var(--terminal-bg);\n\t\t\t\t\t\tborder: 1px solid var(--terminal-green);\n\t\t\t\t\t\tcolor: var(--terminal-green);\n\t\t\t\t\t\tpadding: 15px;\n\t\t\t\t\t\tz-index: 1001;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\tborder-radius: 0;\n\t\t\t\t\t",t.textContent="🔧 Admin Mode - You can modify the spiral",t.id="spiralViewNotice",document.body.appendChild(t)}},100):window.showNotification("Spiral viewer not available","error");const t=window.hideSpiralGenerator;window.hideSpiralGenerator=function(){const e=document.getElementById("spiralViewNotice");e&&document.body.removeChild(e),t&&t(),window.hideSpiralGenerator=t}}else window.showNotification("Spiral modal not available","error")},window.viewCostTrackerTask=function(t){var e;const n=window.tasks.find(e=>e.id===t);if(!n||"cost-tracker"!==n.type)return void window.showNotification("This is not a cost tracker invoice.","error");const i=n.text,o=window.extractTotalFromTaskText(i)||"N/A";let a=`\n\t\t<h3>💰 Cost Tracker Invoice</h3>\n\t\t<p><strong>Invoice from:</strong> ${(null==(e=window.users[n.createdBy])?void 0:e.displayName)||n.createdBy}</p>\n\t\t<p><strong>Issued on:</strong> ${window.formatDate(n.createdAt)}</p>\n\t\t<p><strong>Status:</strong> ${window.getStatusText(n.status,!1,n.type)}</p>\n\t\t${n.dueDate?`<p><strong>Payment Due:</strong> ${window.formatDate(n.dueDate)}</p>`:""}\n\t\t<p><strong>Penalty if not paid:</strong> -100 points</p>\n\t\t<hr>\n\t\t<div style="white-space: pre-line; font-family: monospace; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">\n\t\t\t${window.escapeHtml(i)}\n\t\t</div>\n\t\t<hr>\n\t\t<h3 style="color: #ff6b6b;">Total Amount Due: <strong>${o}</strong></h3>\n\t`;window.showModal(a)},window.markInvoiceAsPaid=function(t){const e=window.tasks.find(e=>e.id===t);if(!e||"cost-tracker"!==e.type)return void window.showNotification("This is not an invoice.","error");const n=window.extractTotalFromTaskText(e.text)||"Unknown";window.showConfirmModal(`Mark this invoice as paid?\n\nAmount: ${n}\n\nThis will notify the admin that you have made the payment and request approval.`,async e=>{if(!e)return;const i={status:"pending_approval",completedAt:(new Date).toISOString(),completedBy:window.currentUser},{error:o}=await window.supabase.from("tasks").update(i).eq("id",t);o?window.showNotification("Failed to mark invoice as paid","error"):(window.showNotification(`Invoice marked as paid! Awaiting admin approval. Amount: ${n}`),await window.fetchTasksInitial())})},window.approveInvoice=function(t){const e=window.tasks.find(e=>e.id===t);if(!e||"cost-tracker"!==e.type)return void window.showNotification("This is not an invoice.","error");const n=window.extractTotalFromTaskText(e.text)||"Unknown";window.showConfirmModal(`Approve this invoice payment?\n\nAmount: ${n}\n\nThis confirms the payment has been received.`,async e=>{if(!e)return;const i={status:"completed",approvedAt:(new Date).toISOString(),approvedBy:window.currentUser},{error:o}=await window.supabase.from("tasks").update(i).eq("id",t);o?window.showNotification("Failed to approve invoice","error"):(window.showNotification(`Invoice payment approved! Amount: ${n}`),await window.fetchTasksInitial())})},window.renderSuggestions=function(){"suggest"===window.activeTab&&window.renderMySuggestions()},window.renderMySuggestions=function(){var t=window.suggestions.filter(function(t){return t.suggestedBy===window.currentUser}),e=document.getElementById("mySuggestions");if(e)if(0===t.length)e.innerHTML='<div class="empty-state">No suggestions submitted yet</div>';else{const i=t.map(function(t){return'<div class="task-item '+window.getSuggestionStatusClass(t.status)+'"><div class="task-content"><div><span class="status-badge '+window.getSuggestionStatusClass(t.status)+'">'+t.status.charAt(0).toUpperCase()+t.status.slice(1)+'</span><span class="task-text">'+window.escapeHtml(t.description)+'</span><span class="points-badge-small">'+t.suggestedPoints+' pts</span><div class="task-meta">Submitted: '+window.formatDate(t.createdAt)+(t.suggestedDueDate?"<br>Suggested due: "+window.formatDate(t.suggestedDueDate):"")+(t.reviewedAt?"<br>Reviewed: "+window.formatDate(t.reviewedAt)+" by "+(window.users[t.reviewedBy]?window.users[t.reviewedBy].displayName:t.reviewedBy):"")+"</div></div></div></div>"}).join("");try{e.innerHTML=i}catch(n){window.showNotification("Failed to display suggestions.","error")}}},window.renderAdminSuggestions=function(){var t=window.suggestions.filter(function(t){return"pending"===t.status}),e=document.getElementById("suggestedTasks");if(e)if(0===t.length)e.innerHTML='<div class="empty-state">No suggested tasks pending approval</div>';else{const i=t.map(function(t){const e=Math.floor((new Date-new Date(t.createdAt))/864e5),n=0===e?"Today":1===e?"1 day ago":`${e} days ago`;return'<div class="task-item pending-approval suggestion-item"><div class="task-content"><div><span class="status-badge '+window.getSuggestionStatusClass(t.status)+'">Suggested Task</span><span class="task-text">'+window.escapeHtml(t.description)+'</span><span class="points-badge-small">+'+t.suggestedPoints+' pts</span><div class="task-meta"><strong>Suggested by:</strong> '+(window.users[t.suggestedBy]?window.users[t.suggestedBy].displayName:t.suggestedBy)+" ("+n+")<br>"+(t.justification?"<strong>Justification:</strong> "+window.escapeHtml(t.justification)+"<br>":"")+(t.suggestedDueDate?"<strong>Suggested Due:</strong> "+window.formatDate(t.suggestedDueDate)+"<br>":"")+"<strong>Submitted:</strong> "+window.formatDate(t.createdAt)+'</div></div><div class="task-actions"><button class="action-btn check-btn" onclick="window.showEditSuggestionModal('+t.id+')">✏️ Edit & Approve</button><button class="action-btn approve-btn" onclick="window.quickApproveSuggestion('+t.id+')">✅ Quick Approve</button><button class="action-btn reject-btn" onclick="window.rejectSuggestion('+t.id+')">❌ Reject</button></div></div></div>'}).join("");try{e.innerHTML=i}catch(n){window.showNotification("Failed to display suggested tasks.","error")}}},window.quickApproveSuggestion=async function(t){const e=window.suggestions.find(e=>e.id===t);e&&window.showConfirmModal(`Quickly approve this suggestion without editing?\n\nTask: ${e.description}\nPoints: ${e.suggestedPoints}\n\nThis will create the task exactly as suggested.`,async e=>{e&&await window.approveSuggestion(t)})},window.rejectSuggestionWithReason=function(t){var e;const n=window.suggestions.find(e=>e.id===t);if(!n)return;const i=document.createElement("div");i.className="modal-overlay",i.innerHTML=`\n\t\t<div class="modal-content">\n\t\t\t<h3>❌ Reject Suggestion</h3>\n\t\t\t<p><strong>Task:</strong> ${window.escapeHtml(n.description)}</p>\n\t\t\t<p><strong>Suggested by:</strong> ${(null==(e=window.users[n.suggestedBy])?void 0:e.displayName)||n.suggestedBy}</p>\n\t\t\t\n\t\t\t<div class="form-group">\n\t\t\t\t<label class="form-label">Reason for Rejection (Optional)</label>\n\t\t\t\t<textarea \n\t\t\t\t\tid="rejectionReason" \n\t\t\t\t\tclass="form-input" \n\t\t\t\t\trows="3"\n\t\t\t\t\tplaceholder="Explain why this suggestion is being rejected..."\n\t\t\t\t></textarea>\n\t\t\t</div>\n\n\t\t\t<div class="modal-actions">\n\t\t\t\t<button id="confirmReject" class="action-btn reject-btn">Reject Suggestion</button>\n\t\t\t\t<button id="cancelReject" class="action-btn delete-btn">Cancel</button>\n\t\t\t</div>\n\t\t</div>\n\t`,document.body.appendChild(i),document.getElementById("confirmReject").onclick=async function(){const e=document.getElementById("rejectionReason").value.trim(),n={status:"rejected",reviewedBy:window.currentUser,reviewedAt:(new Date).toISOString(),adminnotes:e||"No reason provided"},{error:o}=await window.supabase.from("suggestions").update(n).eq("id",t);o?window.showNotification("Failed to reject suggestion","error"):(window.showNotification("Suggestion rejected"+(e?" with reason":"")),await window.fetchSuggestionsInitial()),document.body.removeChild(i)},document.getElementById("cancelReject").onclick=function(){document.body.removeChild(i)},i.onclick=function(t){t.target===i&&document.body.removeChild(i)}},window.showEditSuggestionModal=function(t){var e;if(!window.hasPermission("approve_suggestions"))return void window.showNotification("You do not have permission to edit suggestions","error");const n=window.suggestions.find(e=>e.id===t);if(!n)return void window.showNotification("Suggestion not found","error");const i=document.createElement("div");i.className="modal-overlay",i.innerHTML=`\n\t\t<div class="modal-content large">\n\t\t\t<h3>✏️ Edit Suggestion Before Approval</h3>\n\t\t\t<p><strong>Original suggestion by:</strong> ${(null==(e=window.users[n.suggestedBy])?void 0:e.displayName)||n.suggestedBy}</p>\n\t\t\t<p><strong>Submitted:</strong> ${window.formatDate(n.createdAt)}</p>\n\t\t\t<hr style="border-color: var(--terminal-green); margin: 20px 0;">\n\t\t\t\n\t\t\t<div class="form-group">\n\t\t\t\t<label class="form-label">Task Description *</label>\n\t\t\t\t<textarea \n\t\t\t\t\tid="editSuggestionDescription" \n\t\t\t\t\tclass="form-input" \n\t\t\t\t\trows="3"\n\t\t\t\t\tmaxlength="500"\n\t\t\t\t\trequired\n\t\t\t\t>${window.escapeHtml(n.description)}</textarea>\n\t\t\t</div>\n\n\t\t\t<div class="form-group">\n\t\t\t\t<label class="form-label">Justification/Notes</label>\n\t\t\t\t<textarea \n\t\t\t\t\tid="editSuggestionJustification" \n\t\t\t\t\tclass="form-input" \n\t\t\t\t\trows="2"\n\t\t\t\t\tplaceholder="Admin notes or justification..."\n\t\t\t\t>${window.escapeHtml(n.justification||"")}</textarea>\n\t\t\t</div>\n\n\t\t\t<div class="form-row">\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label class="form-label">Points (Reward)</label>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="number" \n\t\t\t\t\t\tid="editSuggestionPoints" \n\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\tvalue="${n.suggestedPoints||10}" \n\t\t\t\t\t\tmin="1" \n\t\t\t\t\t\tmax="100"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label class="form-label">Penalty Points</label>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="number" \n\t\t\t\t\t\tid="editSuggestionPenalty" \n\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\tvalue="${Math.floor((n.suggestedPoints||10)/2)}" \n\t\t\t\t\t\tmin="0" \n\t\t\t\t\t\tmax="50"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="form-row">\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label class="form-label">Due Date</label>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\tid="editSuggestionDueDate" \n\t\t\t\t\t\tclass="form-input" \n\t\t\t\t\t\tplaceholder="Select a date and time..."\n\t\t\t\t\t\tvalue="${n.suggestedDueDate||""}"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="form-group">\n\t\t\t\t\t<label class="form-label">\n\t\t\t\t\t\t<input type="checkbox" id="editSuggestionRepeating" />\n\t\t\t\t\t\tMake this a repeating task\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="form-group" id="editRepeatOptions" style="display: none;">\n\t\t\t\t<label class="form-label">Repeat Every</label>\n\t\t\t\t<select id="editSuggestionRepeatInterval" class="form-input">\n\t\t\t\t\t<option value="daily">Daily</option>\n\t\t\t\t\t<option value="weekly">Weekly</option>\n\t\t\t\t\t<option value="monthly">Monthly</option>\n\t\t\t\t</select>\n\t\t\t</div>\n\n\t\t\t<div class="form-group">\n\t\t\t\t<label class="form-label">Assign To</label>\n\t\t\t\t<select id="editSuggestionAssignee" class="form-input">\n\t\t\t\t\t<option value="schinken">Pig (schinken)</option>\n\t\t\t\t\t\x3c!-- Add more users here if needed --\x3e\n\t\t\t\t</select>\n\t\t\t</div>\n\n\t\t\t<div class="suggestion-changes-preview" id="changesPreview" style="display: none;">\n\t\t\t\t<h4 style="color: var(--terminal-green);">📝 Changes Made:</h4>\n\t\t\t\t<div id="changesList"></div>\n\t\t\t</div>\n\n\t\t\t<div class="modal-actions">\n\t\t\t\t<button id="approveSuggestionEdited" class="action-btn approve-btn">\n\t\t\t\t\tApprove & Create Task\n\t\t\t\t</button>\n\t\t\t\t<button id="previewSuggestionChanges" class="action-btn check-btn">\n\t\t\t\t\tPreview Changes\n\t\t\t\t</button>\n\t\t\t\t<button id="cancelSuggestionEdit" class="action-btn delete-btn">\n\t\t\t\t\tCancel\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t`,document.body.appendChild(i);const o=document.getElementById("editSuggestionDueDate");o&&"undefined"!=typeof flatpickr&&flatpickr(o,{enableTime:!0,dateFormat:"Y-m-dTH:i",time_24hr:!0,minuteIncrement:1,placeholder:"Select a date and time..."});const a=document.getElementById("editSuggestionRepeating"),s=document.getElementById("editRepeatOptions");a&&s&&a.addEventListener("change",function(){s.style.display=this.checked?"block":"none"}),document.getElementById("previewSuggestionChanges").onclick=function(){window.previewSuggestionChanges(n)},document.getElementById("approveSuggestionEdited").onclick=async function(){await window.approveEditedSuggestion(t)},document.getElementById("cancelSuggestionEdit").onclick=function(){document.body.removeChild(i)},i.onclick=function(t){t.target===i&&document.body.removeChild(i)}},window.previewSuggestionChanges=function(t){const e=document.getElementById("editSuggestionDescription").value.trim(),n=document.getElementById("editSuggestionJustification").value.trim(),i=parseInt(document.getElementById("editSuggestionPoints").value)||10,o=parseInt(document.getElementById("editSuggestionPenalty").value)||5,a=document.getElementById("editSuggestionDueDate").value,s=document.getElementById("editSuggestionRepeating").checked,r=document.getElementById("editSuggestionRepeatInterval").value;document.getElementById("editSuggestionAssignee").value;const d=[];e!==t.description&&d.push(`<div class="change-item">\n\t\t\t<strong>Description:</strong><br>\n\t\t\t<span class="old-value">Old: ${window.escapeHtml(t.description)}</span><br>\n\t\t\t<span class="new-value">New: ${window.escapeHtml(e)}</span>\n\t\t</div>`),i!==t.suggestedPoints&&d.push(`<div class="change-item">\n\t\t\t<strong>Points:</strong> ${t.suggestedPoints} → ${i}\n\t\t</div>`),o!==Math.floor(t.suggestedPoints/2)&&d.push(`<div class="change-item">\n\t\t\t<strong>Penalty Points:</strong> ${Math.floor(t.suggestedPoints/2)} → ${o}\n\t\t</div>`),a!==(t.suggestedDueDate||"")&&d.push(`<div class="change-item">\n\t\t\t<strong>Due Date:</strong> ${t.suggestedDueDate?window.formatDate(t.suggestedDueDate):"None"} → ${a?window.formatDate(a):"None"}\n\t\t</div>`),s&&d.push(`<div class="change-item">\n\t\t\t<strong>Repeating:</strong> Added ${r} repetition\n\t\t</div>`),n!==(t.justification||"")&&d.push(`<div class="change-item">\n\t\t\t<strong>Justification:</strong><br>\n\t\t\t<span class="old-value">Old: ${window.escapeHtml(t.justification||"None")}</span><br>\n\t\t\t<span class="new-value">New: ${window.escapeHtml(n||"None")}</span>\n\t\t</div>`);const c=document.getElementById("changesPreview"),l=document.getElementById("changesList");d.length>0?(l.innerHTML=d.join(""),c.style.display="block"):(l.innerHTML='<div class="no-changes">No changes made to original suggestion.</div>',c.style.display="block")},window.approveEditedSuggestion=async function(t){const e=window.suggestions.find(e=>e.id===t);if(!e)return void window.showNotification("Suggestion not found","error");const n=document.getElementById("editSuggestionDescription").value.trim(),i=document.getElementById("editSuggestionJustification").value.trim(),o=parseInt(document.getElementById("editSuggestionPoints").value)||10,a=parseInt(document.getElementById("editSuggestionPenalty").value)||5,s=document.getElementById("editSuggestionDueDate").value,r=document.getElementById("editSuggestionRepeating").checked,d=document.getElementById("editSuggestionRepeatInterval").value,c=document.getElementById("editSuggestionAssignee").value;if(n)if(o<1||o>100)window.showNotification("Points must be between 1 and 100","error");else if(a<0||a>50)window.showNotification("Penalty points must be between 0 and 50","error");else{if(s){const t=new Date(s),e=new Date;if(isNaN(t.getTime()))return void window.showNotification("Invalid due date format","error");if(t<e)return void window.showNotification("Due date cannot be in the past","error")}try{const l={text:n,status:"todo",type:"regular",createdAt:(new Date).toISOString(),createdBy:window.currentUser,assignedTo:c,points:o,penaltyPoints:a,dueDate:s||null,isRepeating:r,repeatInterval:r?d:null,completedAt:null,completedBy:null,approvedAt:null,approvedBy:null,isOverdue:!1,originalSuggestionid:t,originalSuggestedby:e.suggestedBy},w={status:"approved",reviewedBy:window.currentUser,reviewedAt:(new Date).toISOString(),adminnotes:`Edited before approval. Original points: ${e.suggestedPoints}, Final points: ${o}. ${i?"Admin notes: "+i:""}`},{error:u}=await window.supabase.from("tasks").insert([l]),{error:p}=await window.supabase.from("suggestions").update(w).eq("id",t);if(u||p)return void window.showNotification("Failed to approve suggestion","error");const m=document.querySelector(".modal-overlay");m&&document.body.removeChild(m),window.showNotification(`Suggestion approved and edited! Task created with ${o} points${r?" (Repeating)":""}`),await window.fetchTasksInitial(),await window.fetchSuggestionsInitial()}catch(l){window.showNotification("An error occurred while processing the suggestion","error")}}else window.showNotification("Please enter a task description","error")},window.renderCalendar=function(){var t=document.getElementById("fullcalendar");if(t){window.fullCalendarInstance&&window.fullCalendarInstance.destroy();var e=[];window.tasks&&Array.isArray(window.tasks)&&(e=window.tasks.filter(function(t){return t&&t.assignedTo===window.currentUser&&t.dueDate}).map(function(t){if(t.isRepeating&&t.repeatInterval&&t.dueDate){if("undefined"!=typeof RRule){var e;switch(t.repeatInterval){case"daily":default:e=RRule.DAILY;break;case"weekly":e=RRule.WEEKLY;break;case"monthly":e=RRule.MONTHLY}return{id:t.id,title:t.text+" (Repeating)",rrule:{freq:e,dtstart:t.dueDate},duration:"01:00",description:t.text,classNames:["fc-event-repeating"],extendedProps:{originalTask:t}}}return{id:t.id,title:t.text+" (Repeating)",start:t.dueDate,allDay:!t.dueDate||10===t.dueDate.length,description:t.text,classNames:["fc-event-repeating"],extendedProps:{originalTask:t}}}return{id:t.id,title:t.text,start:t.dueDate,end:t.endDateTime||null,allDay:!t.dueDate||10===t.dueDate.length,description:t.text,classNames:["fc-event-normal"],extendedProps:{originalTask:t}}}));var n={initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay,listWeek"},height:"auto",contentHeight:"auto",aspectRatio:1.8,events:e,eventClick:function(t){var e=t.event.extendedProps.originalTask,n=e.dueDate?window.formatDate(e.dueDate):"N/A",i=e.endDateTime?window.formatDate(e.endDateTime):"N/A",o=e.dueDate&&10===e.dueDate.length?"Yes":"No",a=e.text||"No description available.",s=e.isRepeating?"Repeating Task":"One-time Task",r=window.getStatusText(e.status,window.isTaskOverdue(e),e.type,e.appealStatus),d='<h3 class="">'+window.escapeHtml(e.text)+'</h3><p class=""><strong>Type:</strong> '+s+'</p><p class=""><strong>Status:</strong> '+r+'</p><p class=""><strong>Start:</strong> '+n+"</p>"+(e.endDateTime?'<p class=""><strong>End:</strong> '+i+"</p>":"")+'<p class=""><strong>All Day:</strong> '+o+'</p><p class=""><strong>Description:</strong> '+window.escapeHtml(a)+"</p>"+(e.points?'<p class=""><strong>Points:</strong> '+e.points+"</p>":"")+(e.penaltyPoints?'<p class=""><strong>Penalty:</strong> '+e.penaltyPoints+"</p>":"")+(e.createdBy?'<p class=""><strong>Created By:</strong> '+(window.users[e.createdBy]?window.users[e.createdBy].displayName:e.createdBy)+"</p>":"")+(e.completedBy?'<p class=""><strong>Completed By:</strong> '+(window.users[e.completedBy]?window.users[e.completedBy].displayName:e.completedBy)+"</p>":"")+(e.approvedBy?'<p class=""><strong>Approved By:</strong> '+(window.users[e.approvedBy]?window.users[e.approvedBy].displayName:e.approvedBy)+"</p>":"")+(e.appealText?'<p class=""><strong>Appeal Reason:</strong> '+window.escapeHtml(e.appealText)+"</p>":"");window.showModal(d)}};try{window.fullCalendarInstance=new FullCalendar.Calendar(t,n),window.fullCalendarInstance.render()}catch(o){var i='<div style="padding: 20px; text-align: center; color: #666;"><h3>Calendar Loading...</h3><p>There was an issue loading the calendar. Please refresh the page.</p><div style="margin-top: 20px;"><strong>Tasks with due dates:</strong><br>';e.length>0?i+=e.map(function(t){return"• "+t.title+" - "+(t.start||"No date")}).join("<br>"):i+="No tasks scheduled",i+="</div></div>",t.innerHTML=i}}},window.renderDashboard=function(){if(window.hasPermission("view_dashboard")){var t=window.userActivityLog.filter(function(t){return"schinken"===t.user})[0],e=t&&"login"===t.action,n=window.tasks.filter(function(t){return"completed"!==t.status&&"demerit"!==t.type&&"schinken"===t.assignedTo}),i=window.tasks.filter(function(t){return"completed"===t.status&&"schinken"===t.assignedTo}),o=window.tasks.filter(function(t){return"demerit"!==t.type&&"schinken"===t.assignedTo}),a=o.length>0?Math.round(i.length/o.length*100):0,s=window.tasks.filter(function(t){return"demerit"===t.type}).length,r=document.getElementById("userStatus"),d=document.getElementById("activeTasks"),c=document.getElementById("completionRate"),l=document.getElementById("demeritsIssuedCount");r&&(r.textContent=e?"Online":"Offline",r.style.color=e?"#059669":"#dc2626"),d&&(d.textContent=n.length),c&&(c.textContent=a+"%"),l&&(l.textContent=s),window.updateActiveCostTrackersCount(),window.addAdminPointsControl(),window.renderUserActivityLog(),window.renderUserProgress(),window.renderActiveCostTrackersAdmin()}},window.addAdminPointsControl=function(){if(!window.hasPermission("manage_users"))return;if(document.getElementById("adminPointsControl"))return void window.updateAdminPointsDisplay();const t=document.querySelector(".dashboard-stats");if(!t)return;const e=window.users.schinken.points||0;let n=e<0?"#ff6b6b":0===e?"#ffff00":"#00ff00";const i=document.createElement("div");i.className="stat-card",i.id="adminPointsControl",i.innerHTML=`\n\t\t<h3>👑 Admin: Set User Points</h3>\n\t\t<div class="stat-number" style="color: ${n}; margin-bottom: 15px;">${e}</div>\n\t\t<div style="display: flex; gap: 10px; align-items: center;">\n\t\t\t<input \n\t\t\t\ttype="number" \n\t\t\t\tid="adminPointsInput" \n\t\t\t\tclass="form-input" \n\t\t\t\tplaceholder="New points value"\n\t\t\t\tvalue="${e}"\n\t\t\t\tstyle="width: 120px; padding: 8px; font-size: 14px;"\n\t\t\t\tonkeypress="if(event.key==='Enter') window.setUserPoints()"\n\t\t\t\tonfocus="this.select()"\n\t\t\t>\n\t\t\t<button \n\t\t\t\tclass="action-btn approve-btn" \n\t\t\t\tonclick="window.setUserPoints()"\n\t\t\t\tstyle="padding: 8px 16px; font-size: 14px;"\n\t\t\t>\n\t\t\t\tSet\n\t\t\t</button>\n\t\t</div>\n\t\t<div style="margin-top: 10px; font-size: 12px; color: var(--text-color-medium);">\n\t\t\tCurrent: ${window.users.schinken.displayName}\n\t\t</div>\n\t`,t.insertBefore(i,t.firstChild)},window.updateAdminPointsDisplay=function(){const t=document.getElementById("adminPointsControl");if(!t)return;const e=window.users.schinken.points||0;let n=e<0?"#ff6b6b":0===e?"#ffff00":"#00ff00";const i=t.querySelector(".stat-number"),o=t.querySelector("#adminPointsInput");i&&(i.textContent=e,i.style.color=n),o&&(o.value=e,o.placeholder=`Current: ${e}`)},window.renderUserActivityLog=function(){var t=document.getElementById("userActivityLog");if(t){var e=window.userActivityLog.filter(function(t){return"schinken"===t.user||"skeen"===t.user});0===e.length?t.innerHTML='<div class="empty-state">No user activity recorded</div>':t.innerHTML=e.slice(0,20).map(function(t){var e;return e="schinken"===t.user?"login"===t.action?"🔓 User Logged In":"logout"===t.action?"🔒 User Logged Out":"points_changed"===t.action?"🎯 Points Changed":"📝 "+t.action:"login"===t.action?"🔓 Admin Logged In":"logout"===t.action?"🔒 Admin Logged Out":"points_changed"===t.action?"👑 Admin Changed Points":"👑 "+t.action,t.details&&(e+="<br><small style='color: var(--text-color-medium);'>"+t.details+"</small>"),'<div class="activity-item"><div class="activity-action activity-'+t.action+'">'+e+'</div><div class="activity-time">'+window.formatDate(t.timestamp)+"</div></div>"}).join("")}},window.renderUserProgress=function(){var t=document.getElementById("userProgressList");if(t){var e=window.users.schinken,n=window.tasks.filter(function(t){return"schinken"===t.assignedTo&&"demerit"!==t.type}),i=n.filter(function(t){return"completed"===t.status}),o=n.filter(function(t){return"todo"===t.status||"pending_approval"===t.status}),a=n.filter(function(t){return window.isTaskOverdue(t)&&"completed"!==t.status}),s=window.tasks.filter(function(t){return"demerit"===t.type&&"schinken"===t.assignedTo}),r=n.length>0?Math.round(i.length/n.length*100):0,d="",c="";e.points<0?(d="negative-points",c="color: #ff6b6b; font-weight: bold; text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);"):c=0===e.points?"color: #ffff00; font-weight: bold;":"color: #00ff00; font-weight: bold;",t.innerHTML='<div class="progress-item"><div><div class="user-name">'+e.displayName+'</div><div class="progress-bar"><div class="progress-fill" style="width: '+r+'%"></div></div></div><div class="user-stats"><span class="'+d+'" style="'+c+'">'+e.points+" pts</span><span>"+i.length+" done</span><span>"+o.length+" pending</span><span>"+a.length+" overdue</span><span>"+s.length+" demerits</span></div></div>"}},window.updateStats=function(){var t=window.tasks.filter(function(t){return"skeen"===window.currentUser||t.assignedTo===window.currentUser}),e=t.filter(function(t){return"demerit"!==t.type}).length,n=t.filter(function(t){return("todo"===t.status||"pending_approval"===t.status)&&"demerit"!==t.type}).length,i=t.filter(function(t){return"completed"===t.status}).length,o=document.getElementById("totalTasksStat"),a=document.getElementById("pendingCountStat"),s=document.getElementById("completedCountStat"),r=document.getElementById("myPointsStat");if(o&&(o.textContent=e),a&&(a.textContent=n),s&&(s.textContent=i),r&&window.users[window.currentUser]){var d=window.users[window.currentUser].points;r.textContent=d,r.className="stat-number",d<0?(r.classList.add("negative"),r.style.color="#ff6b6b",r.style.textShadow="0 0 10px rgba(255, 107, 107, 0.5)"):0===d?(r.classList.add("zero"),r.style.color="#ffff00",r.style.textShadow="0 0 10px rgba(255, 255, 0, 0.5)"):(r.classList.add("positive"),r.style.color="#00ff00",r.style.textShadow="0 0 10px rgba(0, 255, 0, 0.5)")}},window.renderDashboard=function(){if(window.hasPermission("view_dashboard")){var t=window.userActivityLog.filter(function(t){return"schinken"===t.user})[0],e=t&&"login"===t.action,n=window.tasks.filter(function(t){return"completed"!==t.status&&"demerit"!==t.type&&"schinken"===t.assignedTo}),i=window.tasks.filter(function(t){return"completed"===t.status&&"schinken"===t.assignedTo}),o=window.tasks.filter(function(t){return"demerit"!==t.type&&"schinken"===t.assignedTo}),a=o.length>0?Math.round(i.length/o.length*100):0,s=window.tasks.filter(function(t){return"demerit"===t.type}).length,r=document.getElementById("userStatus"),d=document.getElementById("activeTasks"),c=document.getElementById("completionRate"),l=document.getElementById("demeritsIssuedCount");r&&(r.textContent=e?"Online":"Offline",r.style.color=e?"#059669":"#dc2626"),d&&(d.textContent=n.length),c&&(c.textContent=a+"%"),l&&(l.textContent=s),window.updateActiveCostTrackersCount(),window.updateInvoiceTotals(),window.addAdminPointsControl(),window.renderUserActivityLog(),window.renderUserProgress(),window.renderActiveCostTrackersAdmin()}},window.updateInvoiceTotals=function(){const t=window.tasks.filter(t=>"cost-tracker"===t.type),e=t.filter(t=>"completed"===t.status),n=t.filter(t=>"pending_approval"===t.status),i=t.filter(t=>"failed"===t.status);let o=0,a=0,s=0;e.forEach(t=>{const e=window.extractTotalFromTaskText(t.text);if(e){const t=parseFloat(e.replace(/[^\d.-]/g,""));isNaN(t)||(o+=t)}}),n.forEach(t=>{const e=window.extractTotalFromTaskText(t.text);if(e){const t=parseFloat(e.replace(/[^\d.-]/g,""));isNaN(t)||(a+=t)}}),i.forEach(t=>{const e=window.extractTotalFromTaskText(t.text);if(e){const t=parseFloat(e.replace(/[^\d.-]/g,""));isNaN(t)||(s+=t)}}),window.updateInvoiceStatCards(o,a,s,e.length,n.length,i.length)},window.updateInvoiceStatCards=function(t,e,n,i,o,a){const s=document.querySelector(".dashboard-stats");if(!s)return;let r=document.getElementById("invoicePaidStat"),d=document.getElementById("invoicePendingStat"),c=document.getElementById("invoiceDeniedStat");r||(r=document.createElement("div"),r.className="stat-card",r.id="invoicePaidStat",s.appendChild(r)),r.innerHTML=`\n\t\t<h3>💰 Invoices Paid</h3>\n\t\t<div class="stat-number" style="color: #00ff00;">€${t.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${i} invoice${1!==i?"s":""} completed\n\t\t</div>\n\t`,d||(d=document.createElement("div"),d.className="stat-card",d.id="invoicePendingStat",s.appendChild(d)),d.innerHTML=`\n\t\t<h3>⏳ Invoices Pending</h3>\n\t\t<div class="stat-number" style="color: #ffff00;">€${e.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${o} invoice${1!==o?"s":""} awaiting approval\n\t\t</div>\n\t`,c||(c=document.createElement("div"),c.className="stat-card",c.id="invoiceDeniedStat",s.appendChild(c)),c.innerHTML=`\n\t\t<h3>❌ Invoices Denied</h3>\n\t\t<div class="stat-number" style="color: #ff6b6b;">€${n.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${a} invoice${1!==a?"s":""} denied payment\n\t\t</div>\n\t`,[r,d,c].forEach(t=>{t.addEventListener("mouseenter",function(){this.style.boxShadow="0 0 15px rgba(0, 255, 0, 0.3)"}),t.addEventListener("mouseleave",function(){this.style.boxShadow=""})})},window.extractTotalFromTaskText=function(t){if(!t)return null;const e=t.match(/TOTAL AMOUNT DUE:\s*([€£$¥]\d+(?:\.\d{2})?)/);if(e)return e[1];const n=t.match(/([€£$¥]\d+(?:\.\d{2})?)/);return n?n[1]:null},window.getInvoiceStatistics=function(){const t=window.tasks.filter(t=>"cost-tracker"===t.type),e={total:t.length,paid:0,pending:0,denied:0,overdue:0,totalPaidAmount:0,totalPendingAmount:0,totalDeniedAmount:0,averageInvoiceValue:0,invoicesByMonth:{},recentInvoices:[]};let n=0;const i=new Date;return t.forEach(t=>{const o=window.extractTotalFromTaskText(t.text),a=o?parseFloat(o.replace(/[^\d.-]/g,"")):0;switch(isNaN(a)||(n+=a),t.status){case"completed":e.paid++,e.totalPaidAmount+=a;break;case"pending_approval":e.pending++,e.totalPendingAmount+=a;break;case"failed":e.denied++,e.totalDeniedAmount+=a}if(t.dueDate&&"completed"!==t.status){new Date(t.dueDate)<i&&e.overdue++}const s=new Date(t.createdAt),r=`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}`;e.invoicesByMonth[r]||(e.invoicesByMonth[r]={count:0,totalAmount:0}),e.invoicesByMonth[r].count++,e.invoicesByMonth[r].totalAmount+=a;(i-s)/864e5<=7&&e.recentInvoices.push({id:t.id,amount:o,status:t.status,createdAt:t.createdAt,dueDate:t.dueDate})}),e.averageInvoiceValue=e.total>0?n/e.total:0,e},window.debugInvoiceStats=function(){return window.getInvoiceStatistics()},window.updateInvoiceStatCards=function(t,e,n,i,o,a){const s=document.querySelector(".dashboard-stats");if(!s)return;let r=document.getElementById("invoicePaidStat"),d=document.getElementById("invoicePendingStat"),c=document.getElementById("invoiceDeniedStat");r||(r=document.createElement("div"),r.className="stat-card clickable-stat-card",r.id="invoicePaidStat",r.style.cursor="pointer",s.appendChild(r)),r.innerHTML=`\n\t\t<h3>💰 Invoices Paid</h3>\n\t\t<div class="stat-number" style="color: #00ff00;">€${t.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${i} invoice${1!==i?"s":""} completed\n\t\t</div>\n\t\t<div class="stat-action-hint" style="font-size: 10px; color: var(--terminal-green); margin-top: 8px;">\n\t\t\tClick to view details\n\t\t</div>\n\t`,d||(d=document.createElement("div"),d.className="stat-card clickable-stat-card",d.id="invoicePendingStat",d.style.cursor="pointer",s.appendChild(d)),d.innerHTML=`\n\t\t<h3>⏳ Invoices Pending</h3>\n\t\t<div class="stat-number" style="color: #ffff00;">€${e.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${o} invoice${1!==o?"s":""} awaiting approval\n\t\t</div>\n\t\t<div class="stat-action-hint" style="font-size: 10px; color: var(--terminal-green); margin-top: 8px;">\n\t\t\tClick to view details\n\t\t</div>\n\t`,c||(c=document.createElement("div"),c.className="stat-card clickable-stat-card",c.id="invoiceDeniedStat",c.style.cursor="pointer",s.appendChild(c)),c.innerHTML=`\n\t\t<h3>❌ Invoices Denied</h3>\n\t\t<div class="stat-number" style="color: #ff6b6b;">€${n.toFixed(2)}</div>\n\t\t<div class="stat-meta" style="font-size: 12px; color: var(--terminal-gray-light); margin-top: 5px;">\n\t\t\t${a} invoice${1!==a?"s":""} denied payment\n\t\t</div>\n\t\t<div class="stat-action-hint" style="font-size: 10px; color: var(--terminal-green); margin-top: 8px;">\n\t\t\tClick to view details\n\t\t</div>\n\t`,r.onclick=()=>window.showInvoiceDetailsModal("completed"),d.onclick=()=>window.showInvoiceDetailsModal("pending_approval"),c.onclick=()=>window.showInvoiceDetailsModal("failed"),[r,d,c].forEach(t=>{t.addEventListener("mouseenter",function(){this.style.transform="scale(1.02)",this.style.boxShadow="0 0 15px rgba(0, 255, 0, 0.3)"}),t.addEventListener("mouseleave",function(){this.style.transform="scale(1)",this.style.boxShadow=""})})},window.showInvoiceDetailsModal=function(t){const e=window.tasks.filter(e=>"cost-tracker"===e.type&&e.status===t);let n="",i="",o="";switch(t){case"completed":n="Paid Invoices",i="#00ff00",o="💰";break;case"pending_approval":n="Pending Invoices",i="#ffff00",o="⏳";break;case"failed":n="Denied Invoices",i="#ff6b6b",o="❌";break;default:n="All Invoices",i="#00ff00",o="📄"}let a=0;e.forEach(t=>{const e=window.extractTotalFromTaskText(t.text);if(e){const t=parseFloat(e.replace(/[^\d.-]/g,""));isNaN(t)||(a+=t)}});let s="";s=0===e.length?`<div class="empty-state">No ${n.toLowerCase()} found</div>`:e.map(e=>{const n=window.extractTotalFromTaskText(e.text)||"N/A",o=Math.floor((new Date-new Date(e.createdAt))/864e5),a=e.dueDate&&new Date(e.dueDate)<new Date&&"completed"!==e.status;return`\n\t\t\t\t<div class="invoice-detail-item" ${a?'style="border-left: 3px solid #ff6b6b;"':""}>\n\t\t\t\t\t<div class="invoice-detail-header">\n\t\t\t\t\t\t<span class="invoice-amount" style="color: ${i}; font-weight: bold;">${n}</span>\n\t\t\t\t\t\t<span class="invoice-date">${0===o?"Today":1===o?"1 day ago":`${o} days ago`}</span>\n\t\t\t\t\t\t${a?'<span class="overdue-badge">OVERDUE</span>':""}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="invoice-description">\n\t\t\t\t\t\t${window.escapeHtml(e.text.split("\n")[0])}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="invoice-metadata">\n\t\t\t\t\t\tCreated: ${window.formatDate(e.createdAt)}\n\t\t\t\t\t\t${e.dueDate?" | Due: "+window.formatDate(e.dueDate):""}\n\t\t\t\t\t\t${e.completedAt?" | Completed: "+window.formatDate(e.completedAt):""}\n\t\t\t\t\t\t${e.approvedAt?" | Approved: "+window.formatDate(e.approvedAt):""}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="invoice-actions">\n\t\t\t\t\t\t<button class="action-btn check-btn" onclick="window.viewCostTrackerTask(${e.id})">View Full Invoice</button>\n\t\t\t\t\t\t${"pending_approval"===t?`<button class="action-btn approve-btn" onclick="window.approveInvoice(${e.id}); window.hideModal();">Approve Payment</button>\n\t\t\t\t\t\t\t <button class="action-btn reject-btn" onclick="window.rejectTask(${e.id}); window.hideModal();">Deny Payment</button>`:""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`}).join("");const r=`\n\t\t<div class="invoice-details-modal">\n\t\t\t<h3 style="color: ${i};">${o} ${n}</h3>\n\t\t\t<div class="invoice-summary">\n\t\t\t\t<div class="summary-stat">\n\t\t\t\t\t<span class="summary-label">Total Count:</span>\n\t\t\t\t\t<span class="summary-value">${e.length}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="summary-stat">\n\t\t\t\t\t<span class="summary-label">Total Amount:</span>\n\t\t\t\t\t<span class="summary-value" style="color: ${i};">€${a.toFixed(2)}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="summary-stat">\n\t\t\t\t\t<span class="summary-label">Average:</span>\n\t\t\t\t\t<span class="summary-value">€${e.length>0?(a/e.length).toFixed(2):"0.00"}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<hr style="border-color: var(--terminal-green); margin: 20px 0;">\n\t\t\t<div class="invoice-details-list" style="max-height: 400px; overflow-y: auto;">\n\t\t\t\t${s}\n\t\t\t</div>\n\t\t\t<div class="modal-actions" style="margin-top: 20px;">\n\t\t\t\t<button class="action-btn approve-btn" onclick="window.exportInvoiceData('${t}')">Export Data</button>\n\t\t\t\t<button class="action-btn delete-btn" onclick="window.hideModal()">Close</button>\n\t\t\t</div>\n\t\t</div>\n\t`;window.showModal(r)},window.exportInvoiceData=function(t){const e=window.tasks.filter(e=>"cost-tracker"===e.type&&e.status===t);if(0===e.length)return void window.showNotification("No invoices to export","warning");let n="Invoice ID,Amount,Status,Created Date,Due Date,Completed Date,Approved Date,Description\n";e.forEach(t=>{const e=window.extractTotalFromTaskText(t.text)||"N/A",i="N/A"!==e?e.replace(/[^\d.-]/g,""):"0",o=t.text.split("\n")[0].replace(/"/g,'""');n+=`${t.id},"${i}","${t.status}","${t.createdAt}","${t.dueDate||""}","${t.completedAt||""}","${t.approvedAt||""}","${o}"\n`});const i=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),a=URL.createObjectURL(i);o.setAttribute("href",a),o.setAttribute("download",`invoices_${t}_${(new Date).toISOString().split("T")[0]}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),window.showNotification(`Invoice data exported successfully! (${e.length} records)`,"success")},window.hideModal=function(){const t=document.getElementById("eventModal");t&&t.classList.add("hidden")},window.getMonthlyInvoiceTrends=function(t=6){const e=window.tasks.filter(t=>"cost-tracker"===t.type),n={},i=new Date;for(let o=t-1;o>=0;o--){const t=new Date(i.getFullYear(),i.getMonth()-o,1),e=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}`;n[e]={month:t.toLocaleString("default",{month:"long",year:"numeric"}),paid:{count:0,amount:0},pending:{count:0,amount:0},denied:{count:0,amount:0},total:{count:0,amount:0}}}return e.forEach(t=>{const e=new Date(t.createdAt),i=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`;if(n[i]){const e=window.extractTotalFromTaskText(t.text),o=e?parseFloat(e.replace(/[^\d.-]/g,"")):0;switch(n[i].total.count++,n[i].total.amount+=o,t.status){case"completed":n[i].paid.count++,n[i].paid.amount+=o;break;case"pending_approval":n[i].pending.count++,n[i].pending.amount+=o;break;case"failed":n[i].denied.count++,n[i].denied.amount+=o}}}),n},window.showMonthlyInvoiceTrends=function(t=6){return window.getMonthlyInvoiceTrends(t)},window.getInvoiceAnalytics=function(){const t=window.tasks.filter(t=>"cost-tracker"===t.type),e=new Date,n=new Date(e.getTime()-2592e6),i=new Date(e.getTime()-6048e5),o={overview:{totalInvoices:t.length,totalValue:0,averageValue:0,paidPercentage:0,pendingPercentage:0,deniedPercentage:0},timeframes:{last7Days:{count:0,value:0,paid:0,pending:0,denied:0},last30Days:{count:0,value:0,paid:0,pending:0,denied:0},allTime:{count:0,value:0,paid:0,pending:0,denied:0}},performance:{averageTimeToPayment:0,overdueInvoices:0,overdueValue:0}};let a=0,s=0;return t.forEach(t=>{const r=window.extractTotalFromTaskText(t.text),d=r?parseFloat(r.replace(/[^\d.-]/g,"")):0,c=new Date(t.createdAt);switch(o.overview.totalValue+=d,o.timeframes.allTime.count++,o.timeframes.allTime.value+=d,c>=i&&(o.timeframes.last7Days.count++,o.timeframes.last7Days.value+=d),c>=n&&(o.timeframes.last30Days.count++,o.timeframes.last30Days.value+=d),t.status){case"completed":if(o.timeframes.allTime.paid++,c>=i&&o.timeframes.last7Days.paid++,c>=n&&o.timeframes.last30Days.paid++,t.approvedAt){const e=(new Date(t.approvedAt)-c)/864e5;a+=e,s++}break;case"pending_approval":o.timeframes.allTime.pending++,c>=i&&o.timeframes.last7Days.pending++,c>=n&&o.timeframes.last30Days.pending++;break;case"failed":o.timeframes.allTime.denied++,c>=i&&o.timeframes.last7Days.denied++,c>=n&&o.timeframes.last30Days.denied++}if(t.dueDate&&"completed"!==t.status){new Date(t.dueDate)<e&&(o.performance.overdueInvoices++,o.performance.overdueValue+=d)}}),o.overview.totalInvoices>0&&(o.overview.averageValue=o.overview.totalValue/o.overview.totalInvoices,o.overview.paidPercentage=o.timeframes.allTime.paid/o.overview.totalInvoices*100,o.overview.pendingPercentage=o.timeframes.allTime.pending/o.overview.totalInvoices*100,o.overview.deniedPercentage=o.timeframes.allTime.denied/o.overview.totalInvoices*100),s>0&&(o.performance.averageTimeToPayment=a/s),o},window.showInvoiceAnalytics=function(){return window.getInvoiceAnalytics()},window.renderRewards=function(){const t=document.getElementById("rewardsList");t&&(0===window.rewards.length?t.innerHTML='<div class="empty-state">No rewards available.</div>':t.innerHTML=window.rewards.map(t=>`\n            <div class="reward-card">\n                <h3>${window.escapeHtml(t.title)}</h3>\n                <p class="description">${window.escapeHtml(t.description)}</p>\n                <div class="cost-badge">${t.cost} Points</div>\n                <div class="type-badge type-${t.type}">${"instant"===t.type?"Instant Purchase":"Authorization Required"}</div>\n                ${"skeen"!==window.currentUser?`<button class="purchase-btn" onclick="window.purchaseReward(${t.id})">Purchase</button>`:""}\n            </div>\n        `).join(""))},window.renderUserRewardPurchases=function(){const t=document.getElementById("myRewardPurchases"),e=document.getElementById("pendingAuthorizations");if(t){const e=window.userRewardPurchases.filter(t=>t.userId===window.currentUser);0===e.length?t.innerHTML='<div class="empty-state">No purchases yet.</div>':t.innerHTML=e.map(t=>`\n                <div class="purchase-item status-${t.status}">\n                    <div class="purchase-content">\n                        <h4>${window.escapeHtml(t.rewards.title||"Unknown Reward")}</h4>\n                        <p>Cost: ${t.purchaseCost} Points</p>\n                        <p>Status: <span class="status-badge ${window.getPurchaseStatusClass(t.status)}">${t.status.replace(/_/g," ")}</span></p>\n                        <p>Date: ${window.formatDate(t.purchaseDate)}</p>\n                        ${"denied"===t.status&&t.notes?`<p class="notes">Reason: ${window.escapeHtml(t.notes)}</p>`:""}\n                    </div>\n                </div>\n            `).join("")}"skeen"===window.currentUser&&e&&window.renderPendingAuthorizations()},window.renderAdminRewardManagement=function(){const t=document.getElementById("currentRewardsList"),e=document.querySelector(".reward-creation-form");if(t&&e){if(!window.hasPermission("manage_rewards"))return e.style.display="none",void(t.closest(".task-section").style.display="none");e.style.display="block",t.closest(".task-section").style.display="block",0===window.rewards.length?t.innerHTML='<div class="empty-state">No rewards defined.</div>':t.innerHTML=window.rewards.map(t=>{var e;return`\n            <div class="task-item">\n                <div class="task-content">\n                    <div>\n                        <span class="status-badge type-${t.type}">${"instant"===t.type?"Instant":"Authorized"}</span>\n                        <span class="task-text">${window.escapeHtml(t.title)}</span>\n                        <span class="points-badge-small">${t.cost} pts</span>\n                        <div class="task-meta">\n                            ${window.escapeHtml(t.description)}\n                            <br>Created: ${window.formatDate(t.createdAt)} by ${(null==(e=window.users[t.createdBy])?void 0:e.displayName)||t.createdBy}\n                        </div>\n                    </div>\n                    <div class="task-actions">\n                        <button class="action-btn check-btn" onclick="window.editReward(${t.id})">Edit</button>\n                        <button class="action-btn delete-btn" onclick="window.deleteReward(${t.id})">Delete</button>\n                    </div>\n                </div>\n            </div>\n        `}).join("")}},window.renderAdminRewardSettings=function(){const t=document.getElementById("instantLimitInput"),e=document.getElementById("resetDurationInput"),n=document.getElementById("requiresAuthAfterLimit"),i=document.getElementById("currentInstantSpendDisplay"),o=document.getElementById("instantLimitDisplay"),a=document.getElementById("lastResetDateDisplay"),s=document.querySelector("#adminSettingsView .task-section:nth-child(3)");if(!s)return;if(!window.hasPermission("manage_rewards"))return void(s.style.display="none");s.style.display="block";const r=window.rewardSystemSettings;t&&(t.value=r.instantPurchaseLimit||0),e&&(e.value=r.resetDurationDays||0),n&&(n.checked=!1!==r.requiresAuthorizationAfterLimit),i&&(i.textContent=r.currentInstantSpend||0),o&&(o.textContent=r.instantPurchaseLimit||0),a&&(a.textContent=r.lastResetAt?window.formatDate(r.lastResetAt):"N/A")},window.updateRewardSettingsUI=function(){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to update reward settings","error");const t=parseInt(document.getElementById("instantLimitInput").value),e=parseInt(document.getElementById("resetDurationInput").value),n=document.getElementById("requiresAuthAfterLimit").checked;isNaN(t)||t<0?window.showNotification("Instant purchase limit must be a non-negative number.","error"):isNaN(e)||e<0?window.showNotification("Reset duration must be a non-negative number of days.","error"):window.updateRewardSystemSettings(t,e,n)},window.editReward=function(t){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to edit rewards","error");const e=window.rewards.find(e=>e.id===t);e&&(document.getElementById("rewardIdToEdit").value=e.id,document.getElementById("rewardTitle").value=e.title,document.getElementById("rewardDescription").value=e.description,document.getElementById("rewardCost").value=e.cost,document.getElementById("rewardType").value=e.type,document.getElementById("saveRewardBtn").textContent="Update Reward",document.getElementById("cancelEditRewardBtn").style.display="inline-block")},window.cancelEditReward=function(){document.getElementById("rewardIdToEdit").value="",document.getElementById("rewardTitle").value="",document.getElementById("rewardDescription").value="",document.getElementById("rewardCost").value="10",document.getElementById("rewardType").value="instant",document.getElementById("saveRewardBtn").textContent="Add Reward",document.getElementById("cancelEditRewardBtn").style.display="none"},window.saveReward=function(){if(!window.hasPermission("manage_rewards"))return void window.showNotification("You do not have permission to save rewards","error");const t=document.getElementById("rewardIdToEdit").value,e=document.getElementById("rewardTitle").value.trim(),n=document.getElementById("rewardDescription").value.trim(),i=parseInt(document.getElementById("rewardCost").value),o=document.getElementById("rewardType").value;!e||isNaN(i)||i<1?window.showNotification("Please enter a valid title and cost for the reward.","error"):(t?window.updateReward(parseInt(t),e,n,i,o):window.addReward(e,n,i,o),window.cancelEditReward())},window.getPurchaseStatusClass=function(t){switch(t){case"purchased":case"authorized":return"status-completed";case"pending_authorization":default:return"status-pending";case"denied":return"status-overdue"}},window.renderPendingAuthorizations=function(){const t=document.getElementById("pendingAuthorizations");if(!t)return;const e=document.querySelector("#adminSettingsView .task-section:nth-child(4)");if(!window.hasPermission("manage_rewards"))return void(e&&(e.style.display="none"));e&&(e.style.display="block");const n=window.userRewardPurchases.filter(t=>"pending_authorization"===t.status);0===n.length?t.innerHTML='<div class="empty-state">No pending authorizations.</div>':t.innerHTML=n.map(t=>{var e;return`\n            <div class="purchase-item pending-approval">\n                <div class="purchase-content">\n                    <h4>${window.escapeHtml(t.rewards.title||"Unknown Reward")} by ${(null==(e=window.users[t.userId])?void 0:e.displayName)||t.userId}</h4>\n                    <p>Cost: ${t.purchaseCost} Points</p>\n                    <p>Requested: ${window.formatDate(t.purchaseDate)}</p>\n                </div>\n                <div class="purchase-actions">\n                    <button class="action-btn approve-btn" onclick="window.authorizePurchase(${t.id})">Authorize</button>\n                    <button class="action-btn reject-btn" onclick="window.denyPurchase(${t.id})">Deny</button>\n                </div>\n            </div>\n        `}).join("")},window.renderActiveCostTrackersAdmin=function(){const t=document.getElementById("activeCostTrackersList");if(!t)return;if(!window.activeCostTrackers||0===window.activeCostTrackers.length)return void(t.innerHTML='<div class="empty-state">No active cost trackers</div>');const e=window.activeCostTrackers.filter(t=>"running"===t.status);0!==e.length?t.innerHTML=e.map(t=>{const e=new Date(t.started_at),i=new Date-e,o=Math.floor(i/36e5),a=Math.floor(i%36e5/6e4),s=Math.floor(i%6e4/1e3),r=`${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`,d=parseInt(t.increment_interval)||6e4,c=parseFloat(t.rate)||0,l=i/d*c;let w=[];try{w=JSON.parse(t.penalties||"[]")}catch(v){}const u=w.reduce((t,e)=>t+(parseFloat(e.amount)||0),0),p=l+u,m=w.length>0?`<br>Penalties: ${w.length} items (+${t.currency}${u.toFixed(2)})`:"";return`\n\t\t\t<div class="activity-item cost-tracker-admin-item">\n\t\t\t\t<div class="activity-action">\n\t\t\t\t\t💰 ${window.escapeHtml(t.description)} \n\t\t\t\t\t<br><span style="color: var(--terminal-green);">by ${window.users[t.created_by]?window.users[t.created_by].displayName:t.created_by}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="cost-tracker-details">\n\t\t\t\t\t<div class="cost-tracker-time">⏱️ Running: ${r}</div>\n\t\t\t\t\t<div class="cost-tracker-cost">💸 Current: ${t.currency}${p.toFixed(2)}</div>\n\t\t\t\t\t<div class="cost-tracker-penalties">${t.currency}${c.toFixed(2)} per ${n(d)}${m}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="cost-tracker-actions">\n\t\t\t\t\t<button class="action-btn check-btn" onclick="window.viewLiveCostTracker(${t.id})">View Details</button>\n\t\t\t\t\t<button class="action-btn delete-btn" onclick="window.window.handleStopTrackerClick((${t.id})">Stop & Invoice</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="activity-time">${window.formatDate(t.started_at)}</div>\n\t\t\t</div>\n\t\t`}).join(""):t.innerHTML='<div class="empty-state">No currently running cost trackers</div>'},window.initializeLiveCostTracker=function(){if("skeen"===window.currentUser){const t=document.getElementById("liveCostTracker");return t&&t.classList.add("hidden"),void(window.userManuallyStoppedTracker=!1)}void 0===window.userManuallyStoppedTracker&&(window.userManuallyStoppedTracker=!1),void 0===window.stoppingTracker&&(window.stoppingTracker=!1),window.activeCostTrackers?setTimeout(()=>{window.userManuallyStoppedTracker||window.stoppingTracker||window.updateLiveCostTracker()},100):window.fetchActiveCostTrackersInitial().then(()=>{window.userManuallyStoppedTracker||window.stoppingTracker||window.updateLiveCostTracker()}).catch(t=>{})},window.updateLiveCostTracker=function(){const t=document.getElementById("liveCostTracker");if(!t)return;if("skeen"===window.currentUser)return t.classList.add("hidden"),void window.clearLiveCostTrackerIntervals();if(window.userManuallyStoppedTracker)return t.classList.add("hidden"),window.clearLiveCostTrackerIntervals(),void(window.currentLiveTracker=null);if(!window.activeCostTrackers||!Array.isArray(window.activeCostTrackers))return t.classList.add("hidden"),window.clearLiveCostTrackerIntervals(),void(window.currentLiveTracker=null);let e=window.activeCostTrackers.find(t=>"running"===t.status);if(window.currentLiveTracker&&!e)return t.classList.add("hidden"),window.clearLiveCostTrackerIntervals(),void(window.currentLiveTracker=null);const n=window.activeCostTrackers.find(t=>{const e=t.created_by||t.createdBy||t.user_id||t.userId,n=t.assigned_to||t.assignedTo,i="running"===t.status,o=n===window.currentUser,a="schinken"===window.currentUser&&"skeen"===e,s=e===window.currentUser;return(o||a||s)&&i});if(!n)return t.classList.add("hidden"),window.clearLiveCostTrackerIntervals(),void(window.currentLiveTracker=null);(!window.currentLiveTracker||window.currentLiveTracker.id!==n.id||window.currentLiveTracker.status!==n.status)&&(window.clearLiveCostTrackerIntervals(),window.currentLiveTracker=n,t.classList.remove("hidden"),window.startLiveCostTrackerUpdates(n))},window.startLiveCostTrackerUpdates=function(t){window.clearLiveCostTrackerIntervals();const e=function(){const e=document.getElementById("liveCostTime"),i=document.getElementById("liveCostAmount"),o=document.getElementById("liveCostRate"),a=document.getElementById("liveCostPenalties");if(e&&i&&o&&a)try{const r=new Date(t.started_at),d=new Date,c=Math.max(0,d-r),l=Math.floor(c/36e5),w=Math.floor(c%36e5/6e4),u=Math.floor(c%6e4/1e3),p=`${l.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}:${u.toString().padStart(2,"0")}`;e.textContent=p;const m=parseInt(t.increment_interval)||6e4,v=parseFloat(t.rate)||0,g=c/m,h=Math.max(0,g*v);let y=[];try{y=JSON.parse(t.penalties||"[]")}catch(s){y=[]}const f=h+y.reduce((t,e)=>{const n=parseFloat(e.amount);return t+(isNaN(n)?0:n)},0);i.textContent=`${t.currency||"€"}${f.toFixed(2)}`,o.textContent=`${t.currency||"€"}${v.toFixed(2)} per ${n(m)}`,y.length>0?(a.style.display="block",a.innerHTML=y.map(e=>{const n=parseFloat(e.amount)||0;return`<div class="live-tracker-penalty">${window.escapeHtml(e.description||"Unknown")}: ${t.currency||"€"}${n.toFixed(2)}</div>`}).join("")):(a.style.display="none",a.innerHTML="")}catch(r){}};e(),window.liveCostTrackerInterval=setInterval(e,1e3),window.liveCostTrackerUpdateInterval=setInterval(async()=>{try{await window.fetchActiveCostTrackersInitial();const e=window.activeCostTrackers&&window.activeCostTrackers.find(e=>e.id===t.id&&"running"===e.status);e?(Object.assign(t,e),window.currentLiveTracker=e):window.updateLiveCostTracker()}catch(e){}},3e4)},window.clearLiveCostTrackerIntervals=function(){window.liveCostTrackerInterval&&(clearInterval(window.liveCostTrackerInterval),window.liveCostTrackerInterval=null),window.liveCostTrackerUpdateInterval&&(clearInterval(window.liveCostTrackerUpdateInterval),window.liveCostTrackerUpdateInterval=null),window.costTrackerDisplayInterval&&(clearInterval(window.costTrackerDisplayInterval),window.costTrackerDisplayInterval=null)},window.updateActiveCostTrackersCount=function(){const t=document.getElementById("activeCostTrackersCount");if(!t)return;const e=window.activeCostTrackers?window.activeCostTrackers.filter(t=>"running"===t.status).length:0;t.textContent=e},window.dismissLiveCostTracker=function(){const t=document.getElementById("liveCostTracker");t&&t.classList.add("hidden"),window.userManuallyStoppedTracker=!0,setTimeout(()=>{window.userManuallyStoppedTracker=!1},1e4),window.clearLiveCostTrackerIntervals()},window.refreshLiveCostTracker=function(){window.updateLiveCostTracker()},window.forceShowLiveCostTracker=function(){window.userManuallyStoppedTracker=!1,window.updateLiveCostTracker()},window.stopLiveCostTrackerAdmin=async function(t){if(window.hasPermission("create_task"))try{window.stoppingTracker=!0,window.userManuallyStoppedTracker=!0,await window.stopLiveCostTracker(t,!0),window.currentLiveTracker&&window.currentLiveTracker.id===t&&(window.currentLiveTracker=null),window.activeLiveTrackerId===t&&(window.activeLiveTrackerId=null),window.showNotification("Cost tracker stopped and invoice created!","success"),await window.fetchActiveCostTrackersInitial(),window.stoppingTracker=!1,setTimeout(()=>{window.userManuallyStoppedTracker=!1},3e3)}catch(e){window.showNotification(`Failed to stop cost tracker: ${e.message}`,"error"),window.stoppingTracker=!1,window.userManuallyStoppedTracker=!1}else window.showNotification("You do not have permission to stop cost trackers","error")},window.forceStopCostTracker=async function(t){var e;if(!t){const n=null==(e=window.activeCostTrackers)?void 0:e.find(t=>"running"===t.status);if(!n)return void window.showNotification("No active tracker to stop","error");t=n.id}if("function"==typeof window.stopLiveCostTracker)try{await window.stopLiveCostTracker(t,!0);window.showNotification("Cost tracker stopped successfully!","success"),window.currentLiveTracker=null,window.clearLiveCostTrackerIntervals(),await window.fetchActiveCostTrackersInitial(),"schinken"===window.currentUser?window.updateLiveCostTracker():"skeen"===window.currentUser&&(window.renderActiveCostTrackersAdmin(),window.updateActiveCostTrackersCount())}catch(n){window.showNotification(`Failed to stop tracker: ${n.message||n}`,"error")}else window.showNotification("Stop function not available","error")},window.viewLiveCostTracker=function(t){var e;const i=window.activeCostTrackers.find(e=>e.id===t);if(!i)return void window.showNotification("Tracker not found","error");const o=new Date(i.started_at),a=new Date-o,s=Math.floor(a/36e5),r=Math.floor(a%36e5/6e4),d=Math.floor(a%6e4/1e3),c=`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`,l=parseInt(i.increment_interval)||6e4,w=parseFloat(i.rate)||0,u=a/l*w;let p=[];try{p=JSON.parse(i.penalties||"[]")}catch(h){}const m=p.reduce((t,e)=>t+(parseFloat(e.amount)||0),0),v=u+m;let g=`\n\t\t<h3>💰 Live Cost Tracker Details</h3>\n\t\t<p><strong>Description:</strong> ${window.escapeHtml(i.description)}</p>\n\t\t<p><strong>Started by:</strong> ${(null==(e=window.users[i.created_by])?void 0:e.displayName)||i.created_by}</p>\n\t\t<p><strong>Running time:</strong> ${c}</p>\n\t\t<p><strong>Rate:</strong> ${i.currency}${w.toFixed(2)} per ${n(l)}</p>\n\t\t<p><strong>Time-based cost:</strong> ${i.currency}${u.toFixed(2)}</p>\n\t\t<p><strong>Started:</strong> ${window.formatDate(i.started_at)}</p>\n\t`;p.length>0&&(g+='<hr><h4>Additional Costs/Penalties:</h4><div class="penalties-list">',p.forEach(t=>{g+=`<div class="penalty-display-item">\n\t\t\t\t<div class="penalty-info">\n\t\t\t\t\t<strong>${window.escapeHtml(t.description)}</strong><br>\n\t\t\t\t\t<span>${i.currency}${parseFloat(t.amount).toFixed(2)}</span><br>\n\t\t\t\t\t<small>Added: ${window.formatDate(t.added_at)}</small>\n\t\t\t\t</div>\n\t\t\t</div>`}),g+=`</div><p><strong>Penalty total:</strong> ${i.currency}${m.toFixed(2)}</p>`),g+=`\n\t\t<hr>\n\t\t<h3 style="color: #ff6b6b;">Total Amount: <strong>${i.currency}${v.toFixed(2)}</strong></h3>\n\t\t<p><em>This will be the invoice amount when the tracker is stopped.</em></p>\n\t`,window.showModal(g)},window.resetCostTrackerState=function(){window.clearLiveCostTrackerIntervals(),window.currentLiveTracker=null,window.activeLiveTrackerId=null,window.userManuallyStoppedTracker=!1,window.stoppingTracker=!1;const t=document.getElementById("liveCostTracker");t&&t.classList.add("hidden")},window.debugTrackerRestart=function(){var t;null==(t=window.activeCostTrackers)||t.filter(t=>"running"===t.status),document.getElementById("liveCostTracker")},window.debugCostTracker=function(){document.getElementById("liveCostTracker")},window.testStopTracker=async function(){var t;if(window.currentLiveTracker)try{return void(await window.forceStopCostTracker(window.currentLiveTracker.id))}catch(n){}const e=null==(t=window.activeCostTrackers)?void 0:t.find(t=>"running"===t.status);if(e)try{return void(await window.forceStopCostTracker(e.id))}catch(n){}},window.initializeToolButtons=function(){const t=()=>{const t=document.getElementById("showSpiralGeneratorBtn"),e=document.getElementById("showCostTrackerBtn");t&&(t.onclick=null,t.addEventListener("click",t=>{t.preventDefault(),window.showSpiralGenerator&&"function"==typeof window.showSpiralGenerator?window.showSpiralGenerator():window.showNotification?window.showNotification("Spiral generator is not available.","error"):alert("Spiral generator is not available.")})),e&&(e.onclick=null,e.addEventListener("click",t=>{t.preventDefault(),window.showCostTracker&&"function"==typeof window.showCostTracker?window.showCostTracker():window.showNotification?window.showNotification("Cost tracker is not available.","error"):alert("Cost tracker is not available.")}))};window.showSpiralGenerator&&window.showCostTracker?t():setTimeout(()=>{window.showSpiralGenerator&&window.showCostTracker,t()},500)},window.ensureModalFunctions=function(){window.showSpiralGenerator||(window.showSpiralGenerator=function(){const t=document.getElementById("spiralModal");t&&(t.classList.remove("hidden"),window.spiral&&window.spiral.init&&(window.spiral.init(),window.spiral.initDefaultText()))}),window.hideSpiralGenerator||(window.hideSpiralGenerator=function(){const t=document.getElementById("spiralModal");t&&t.classList.add("hidden")}),window.showCostTracker||(window.showCostTracker=function(){const t=document.getElementById("costTrackerModal");t&&(t.classList.remove("hidden"),window.costTracker&&window.costTracker.init&&window.costTracker.init(),t.onclick=function(e){e.target===t&&window.hideCostTracker()})}),window.hideCostTracker||(window.hideCostTracker=function(){const t=document.getElementById("costTrackerModal");t&&(window.costTracker&&window.costTracker.resetOnClose&&window.costTracker.resetOnClose(),t.classList.add("hidden"))})},window.addEventListener("load",()=>{window.ensureModalFunctions()}),document.addEventListener("DOMContentLoaded",()=>{window.ensureModalFunctions()});
