<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Collaborative Task Manager</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
				background: rgba(255, 255, 255, 0.95);
				backdrop-filter: blur(10px);
				border-radius: 20px;
				padding: 30px;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
			}

			.setup-container {
				max-width: 600px;
				margin: 0 auto;
				text-align: center;
			}

			.setup-form {
				background: white;
				padding: 40px;
				border-radius: 20px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			}

			.setup-title {
				font-size: 2em;
				color: #333;
				margin-bottom: 20px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.setup-instructions {
				background: #f0f9ff;
				border: 2px solid #bae6fd;
				border-radius: 12px;
				padding: 25px;
				margin-bottom: 30px;
				text-align: left;
			}

			.setup-instructions h3 {
				color: #0369a1;
				margin-bottom: 15px;
				font-size: 1.2em;
			}

			.setup-instructions ol {
				color: #0c4a6e;
				margin-left: 20px;
			}

			.setup-instructions li {
				margin-bottom: 8px;
				line-height: 1.5;
			}

			.setup-instructions a {
				color: #1e40af;
				text-decoration: none;
				font-weight: 600;
			}

			.setup-instructions a:hover {
				text-decoration: underline;
			}

			.firebase-config {
				background: #fef3c7;
				border: 2px solid #fcd34d;
				border-radius: 12px;
				padding: 25px;
				margin-bottom: 30px;
				text-align: left;
			}

			.firebase-config h3 {
				color: #92400e;
				margin-bottom: 15px;
			}

			.config-input {
				width: 100%;
				padding: 12px;
				margin-bottom: 15px;
				border: 2px solid #e2e8f0;
				border-radius: 8px;
				font-size: 14px;
				font-family: monospace;
			}

			.config-input:focus {
				outline: none;
				border-color: #667eea;
			}

			.demo-note {
				background: #fee2e2;
				border: 2px solid #fecaca;
				border-radius: 12px;
				padding: 20px;
				margin-bottom: 30px;
				color: #991b1b;
			}

			.demo-note h3 {
				margin-bottom: 10px;
			}

			.login-container {
				max-width: 400px;
				margin: 0 auto;
				text-align: center;
			}

			.login-form {
				background: white;
				padding: 40px;
				border-radius: 20px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			}

			.login-title {
				font-size: 2em;
				color: #333;
				margin-bottom: 30px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.form-group {
				margin-bottom: 20px;
				text-align: left;
			}

			.form-label {
				display: block;
				margin-bottom: 8px;
				font-weight: 600;
				color: #374151;
			}

			.form-input {
				width: 100%;
				padding: 15px;
				border: 2px solid #e2e8f0;
				border-radius: 12px;
				font-size: 16px;
				transition: all 0.3s ease;
				background: white;
			}

			.form-input:focus {
				outline: none;
				border-color: #667eea;
				box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
			}

			.login-btn,
			.setup-btn {
				width: 100%;
				padding: 15px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				color: white;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 600;
				transition: all 0.3s ease;
				text-transform: uppercase;
				letter-spacing: 1px;
			}

			.login-btn:hover,
			.setup-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
			}

			.error-message,
			.success-message {
				padding: 12px;
				border-radius: 8px;
				margin-bottom: 20px;
				text-align: center;
				font-weight: 500;
			}

			.error-message {
				background: #fee2e2;
				color: #dc2626;
			}

			.success-message {
				background: #d1fae5;
				color: #065f46;
			}

			.demo-credentials {
				background: #f0f9ff;
				border: 2px solid #bae6fd;
				border-radius: 12px;
				padding: 20px;
				margin-top: 30px;
				text-align: left;
			}

			.demo-credentials h3 {
				color: #0369a1;
				margin-bottom: 15px;
				font-size: 1.1em;
			}

			.demo-credentials p {
				margin-bottom: 10px;
				color: #0c4a6e;
			}

			.demo-credentials strong {
				color: #1e40af;
			}

			.header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 30px;
				padding-bottom: 20px;
				border-bottom: 2px solid #e2e8f0;
			}

			.header-left h1 {
				color: #333;
				font-size: 2.5em;
				margin-bottom: 5px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
			}

			.user-info {
				text-align: right;
			}

			.user-badge {
				display: inline-block;
				padding: 8px 16px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				color: white;
				border-radius: 20px;
				font-weight: 600;
				font-size: 14px;
				text-transform: uppercase;
				letter-spacing: 1px;
				margin-bottom: 10px;
			}

			.logout-btn {
				padding: 8px 16px;
				background: #ef4444;
				color: white;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 12px;
				font-weight: 600;
				transition: all 0.3s ease;
				text-transform: uppercase;
				margin-right: 10px;
			}

			.logout-btn:hover {
				background: #dc2626;
				transform: translateY(-1px);
			}

			.connection-status {
				font-size: 12px;
				padding: 4px 8px;
				border-radius: 12px;
				font-weight: 600;
			}

			.status-online {
				background: #d1fae5;
				color: #065f46;
			}

			.status-offline {
				background: #fee2e2;
				color: #991b1b;
			}

			.task-section {
				margin-bottom: 30px;
			}

			.section-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
				padding-bottom: 10px;
				border-bottom: 2px solid #e2e8f0;
			}

			.section-title {
				font-size: 1.5em;
				color: #333;
				font-weight: 600;
			}

			.task-input-container {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
			}

			.task-input {
				flex: 1;
				padding: 15px;
				border: 2px solid #e2e8f0;
				border-radius: 12px;
				font-size: 16px;
				transition: all 0.3s ease;
				background: white;
			}

			.task-input:focus {
				outline: none;
				border-color: #667eea;
				box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
			}

			.add-btn {
				padding: 15px 25px;
				background: linear-gradient(45deg, #10b981, #059669);
				color: white;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				font-weight: 600;
				transition: all 0.3s ease;
				white-space: nowrap;
			}

			.add-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
			}

			.task-list {
				display: flex;
				flex-direction: column;
				gap: 12px;
			}

			.task-item {
				background: white;
				padding: 20px;
				border-radius: 15px;
				border: 2px solid #f1f5f9;
				transition: all 0.3s ease;
				position: relative;
				overflow: hidden;
			}

			.task-item::before {
				content: "";
				position: absolute;
				left: 0;
				top: 0;
				height: 100%;
				width: 4px;
				background: linear-gradient(45deg, #667eea, #764ba2);
				transition: width 0.3s ease;
			}

			.task-item:hover::before {
				width: 8px;
			}

			.task-item.completed {
				background: #f0fdf4;
				border-color: #bbf7d0;
			}

			.task-item.completed::before {
				background: linear-gradient(45deg, #10b981, #059669);
			}

			.task-item.pending-approval {
				background: #fffbeb;
				border-color: #fed7aa;
			}

			.task-item.pending-approval::before {
				background: linear-gradient(45deg, #f59e0b, #d97706);
			}

			.task-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.task-text {
				font-size: 16px;
				color: #374151;
				font-weight: 500;
			}

			.task-item.completed .task-text {
				text-decoration: line-through;
				color: #6b7280;
			}

			.task-actions {
				display: flex;
				gap: 10px;
			}

			.action-btn {
				padding: 8px 16px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 14px;
				font-weight: 600;
				transition: all 0.3s ease;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.check-btn {
				background: linear-gradient(45deg, #3b82f6, #1d4ed8);
				color: white;
			}

			.check-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
			}

			.approve-btn {
				background: linear-gradient(45deg, #10b981, #059669);
				color: white;
			}

			.approve-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
			}

			.delete-btn {
				background: linear-gradient(45deg, #ef4444, #dc2626);
				color: white;
			}

			.delete-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
			}

			.status-badge {
				font-size: 12px;
				padding: 4px 12px;
				border-radius: 20px;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.5px;
				margin-right: 10px;
			}

			.status-pending {
				background: #fef3c7;
				color: #92400e;
			}

			.status-completed {
				background: #d1fae5;
				color: #065f46;
			}

			.empty-state {
				text-align: center;
				padding: 40px;
				color: #6b7280;
				font-style: italic;
			}

			.stats {
				display: flex;
				justify-content: center;
				gap: 30px;
				margin-top: 30px;
				padding: 20px;
				background: rgba(255, 255, 255, 0.5);
				border-radius: 15px;
			}

			.stat-item {
				text-align: center;
			}

			.stat-number {
				font-size: 2em;
				font-weight: bold;
				color: #333;
				display: block;
			}

			.stat-label {
				font-size: 14px;
				color: #6b7280;
				text-transform: uppercase;
				letter-spacing: 1px;
			}

			@media (max-width: 600px) {
				.header {
					flex-direction: column;
					gap: 15px;
					text-align: center;
				}

				.user-info {
					text-align: center;
				}

				.task-input-container {
					flex-direction: column;
				}

				.stats {
					flex-direction: column;
					gap: 15px;
				}

				.task-content {
					flex-direction: column;
					gap: 15px;
					align-items: flex-start;
				}
			}
		</style>
		<script src="config.js"></script>
	</head>
	<body>
		<div class="container">
			<!-- Setup Screen -->
			<div id="setupScreen" class="setup-container">
				<div class="setup-form">
					<h1 class="setup-title">Setup Firebase Integration</h1>

					<div class="demo-note">
						<h3>⚠️ Current Version: Local Demo Only</h3>
						<p>
							This version stores data locally for demonstration.
							To enable true collaboration between users, you need
							to set up Firebase (free). Follow the instructions
							below to enable real-time collaboration.
						</p>
					</div>

					<div class="setup-instructions">
						<h3>🚀 Setup Instructions (5 minutes)</h3>
						<ol>
							<li>
								Go to
								<a
									href="https://console.firebase.google.com"
									target="_blank"
									>Firebase Console</a
								>
							</li>
							<li>Click "Create a project" or "Add project"</li>
							<li>Name your project (e.g., "my-task-manager")</li>
							<li>Disable Google Analytics (not needed)</li>
							<li>Click "Create project"</li>
							<li>
								In the left sidebar, click "Firestore Database"
							</li>
							<li>Click "Create database"</li>
							<li>Choose "Start in test mode" → Next → Done</li>
							<li>
								Go to Project Settings (gear icon) → General tab
							</li>
							<li>
								Scroll down to "Your apps" → Click "Web app"
								(&lt;/&gt;)
							</li>
							<li>Register your app with any name</li>
							<li>Copy the firebaseConfig values below</li>
						</ol>
					</div>

					<div class="firebase-config">
						<h3>📋 Firebase Configuration</h3>
						<p>Paste your Firebase config values here:</p>
						<input
							type="text"
							id="apiKey"
							class="config-input"
							placeholder="apiKey"
						/>
						<input
							type="text"
							id="authDomain"
							class="config-input"
							placeholder="authDomain"
						/>
						<input
							type="text"
							id="projectId"
							class="config-input"
							placeholder="projectId"
						/>
						<input
							type="text"
							id="storageBucket"
							class="config-input"
							placeholder="storageBucket"
						/>
						<input
							type="text"
							id="messagingSenderId"
							class="config-input"
							placeholder="messagingSenderId"
						/>
						<input
							type="text"
							id="appId"
							class="config-input"
							placeholder="appId"
						/>
					</div>

					<button class="setup-btn" onclick="setupFirebase()">
						Connect Firebase
					</button>
					<button
						class="setup-btn"
						onclick="skipSetup()"
						style="background: #6b7280; margin-top: 10px"
					>
						Skip - Use Local Demo
					</button>
				</div>
			</div>

			<!-- Login Screen -->
			<div id="loginScreen" class="login-container" style="display: none">
				<div class="login-form">
					<h1 class="login-title">Task Manager Login</h1>

					<div
						id="errorMessage"
						class="error-message"
						style="display: none"
					></div>
					<div
						id="successMessage"
						class="success-message"
						style="display: none"
					></div>

					<form id="loginForm">
						<div class="form-group">
							<label class="form-label" for="username"
								>Username</label
							>
							<input
								type="text"
								id="username"
								class="form-input"
								required
							/>
						</div>

						<div class="form-group">
							<label class="form-label" for="password"
								>Password</label
							>
							<input
								type="password"
								id="password"
								class="form-input"
								required
							/>
						</div>

						<button type="submit" class="login-btn">Login</button>
					</form>

					<div class="demo-credentials">
						<h3>Demo Accounts</h3>
						<p>
							<strong>Task Creator:</strong><br />
							Username: <strong>creator</strong><br />
							Password: <strong>admin123</strong>
						</p>

						<p>
							<strong>Task Checker:</strong><br />
							Username: <strong>checker</strong><br />
							Password: <strong>user123</strong>
						</p>
					</div>
				</div>
			</div>

			<!-- Main App -->
			<div id="mainApp" style="display: none">
				<div class="header">
					<div class="header-left">
						<h1>Task Manager</h1>
						<p>Collaborative task management</p>
					</div>
					<div class="user-info">
						<div id="userBadge" class="user-badge"></div>
						<button class="logout-btn" onclick="logout()">
							Logout
						</button>
						<div
							id="connectionStatus"
							class="connection-status status-offline"
						>
							Local Mode
						</div>
					</div>
				</div>

				<!-- Creator View -->
				<div id="creatorView" style="display: none">
					<div class="task-section">
						<div class="section-header">
							<h2 class="section-title">Create New Task</h2>
						</div>
						<div class="task-input-container">
							<input
								type="text"
								id="taskInput"
								class="task-input"
								placeholder="Enter a new task..."
								maxlength="200"
							/>
							<button class="add-btn" onclick="addTask()">
								Add Task
							</button>
						</div>
					</div>

					<div class="task-section">
						<div class="section-header">
							<h2 class="section-title">
								Tasks Pending Approval
							</h2>
						</div>
						<div id="pendingTasks" class="task-list"></div>
					</div>

					<div class="task-section">
						<div class="section-header">
							<h2 class="section-title">All Tasks</h2>
						</div>
						<div id="allTasksCreator" class="task-list"></div>
					</div>
				</div>

				<!-- Checker View -->
				<div id="checkerView" style="display: none">
					<div class="task-section">
						<div class="section-header">
							<h2 class="section-title">Tasks to Complete</h2>
						</div>
						<div id="tasksToCheck" class="task-list"></div>
					</div>

					<div class="task-section">
						<div class="section-header">
							<h2 class="section-title">My Completed Tasks</h2>
						</div>
						<div id="completedTasks" class="task-list"></div>
					</div>
				</div>

				<!-- Stats -->
				<div class="stats">
					<div class="stat-item">
						<span id="totalTasks" class="stat-number">0</span>
						<span class="stat-label">Total Tasks</span>
					</div>
					<div class="stat-item">
						<span id="pendingCount" class="stat-number">0</span>
						<span class="stat-label">Pending</span>
					</div>
					<div class="stat-item">
						<span id="completedCount" class="stat-number">0</span>
						<span class="stat-label">Completed</span>
					</div>
				</div>
			</div>
		</div>

		<!-- Firebase Scripts -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

		<script>
			// User configuration
			const users = {
				creator: {
					password: "admin123",
					role: "creator",
					displayName: "Task Creator",
					permissions: [
						"create_task",
						"approve_task",
						"delete_task",
						"view_all_tasks",
					],
				},
				checker: {
					password: "user123",
					role: "checker",
					displayName: "Task Checker",
					permissions: ["check_task", "view_assigned_tasks"],
				},
			};

			let currentUser = null;
			let tasks = [];
			let taskIdCounter = 1;
			let db = null;
			let isFirebaseConnected = false;
			let unsubscribe = null;

			// Load data on page load
			window.addEventListener("load", function () {
				checkSetupStatus();
			});

			function checkSetupStatus() {
				const savedConfig = window.firebaseConfigData;
				if (savedConfig && savedConfig.projectId) {
					initializeFirebase(savedConfig);
				} else {
					showSetup();
				}
			}

			function showSetup() {
				document.getElementById("setupScreen").style.display = "block";
				document.getElementById("loginScreen").style.display = "none";
				document.getElementById("mainApp").style.display = "none";
			}

			function showLogin() {
				document.getElementById("setupScreen").style.display = "none";
				document.getElementById("loginScreen").style.display = "block";
				document.getElementById("mainApp").style.display = "none";
			}

			function showMainApp() {
				document.getElementById("setupScreen").style.display = "none";
				document.getElementById("loginScreen").style.display = "none";
				document.getElementById("mainApp").style.display = "block";

				const user = users[currentUser];
				document.getElementById("userBadge").textContent =
					user.displayName;

				// Update connection status
				const statusEl = document.getElementById("connectionStatus");
				if (isFirebaseConnected) {
					statusEl.textContent = "Connected";
					statusEl.className = "connection-status status-online";
				} else {
					statusEl.textContent = "Local Mode";
					statusEl.className = "connection-status status-offline";
				}

				// Show appropriate view based on role
				if (user.role === "creator") {
					document.getElementById("creatorView").style.display =
						"block";
					document.getElementById("checkerView").style.display =
						"none";
				} else {
					document.getElementById("creatorView").style.display =
						"none";
					document.getElementById("checkerView").style.display =
						"block";
				}

				loadTasks();
			}

			window.setupFirebase = function () {
				const config = {
					apiKey: document.getElementById("apiKey").value.trim(),
					authDomain: document
						.getElementById("authDomain")
						.value.trim(),
					projectId: document
						.getElementById("projectId")
						.value.trim(),
					storageBucket: document
						.getElementById("storageBucket")
						.value.trim(),
					messagingSenderId: document
						.getElementById("messagingSenderId")
						.value.trim(),
					appId: document.getElementById("appId").value.trim(),
				};

				if (!config.apiKey || !config.projectId) {
					showError(
						"Please fill in at least the API Key and Project ID"
					);
					return;
				}

				// Save config
				window.firebaseConfigData = config;

				initializeFirebase(config);
			};

			window.skipSetup = function () {
				isFirebaseConnected = false;
				checkAuthStatus();
			};

			function initializeFirebase(config) {
				try {
					if (!firebase.apps.length) {
						firebase.initializeApp(config);
					}
					db = firebase.firestore();
					isFirebaseConnected = true;

					showSuccess("Firebase connected successfully!");
					setTimeout(() => {
						checkAuthStatus();
					}, 1500);
				} catch (error) {
					console.error("Firebase initialization error:", error);
					showError(
						"Failed to connect to Firebase. Please check your configuration."
					);
					isFirebaseConnected = false;
					setTimeout(() => {
						showSetup();
					}, 2000);
				}
			}

			function skipSetup() {
				isFirebaseConnected = false;
				checkAuthStatus();
			}

			function checkAuthStatus() {
				const savedUser = window.sessionUser;
				if (savedUser && users[savedUser]) {
					currentUser = savedUser;
					showMainApp();
				} else {
					showLogin();
				}
			}

			// Login form handler
			document.addEventListener("DOMContentLoaded", function () {
				const loginForm = document.getElementById("loginForm");
				if (loginForm) {
					loginForm.addEventListener("submit", function (e) {
						e.preventDefault();

						const username = document
							.getElementById("username")
							.value.trim();
						const password =
							document.getElementById("password").value;

						if (
							users[username] &&
							users[username].password === password
						) {
							currentUser = username;
							window.sessionUser = username;
							showMainApp();
							hideError();
						} else {
							showError("Invalid username or password");
						}
					});
				}

				// Add task on Enter key press
				const taskInput = document.getElementById("taskInput");
				if (taskInput) {
					taskInput.addEventListener("keypress", function (e) {
						if (e.key === "Enter") {
							addTask();
						}
					});
				}
			});

			function showError(message) {
				const errorDiv = document.getElementById("errorMessage");
				if (errorDiv) {
					errorDiv.textContent = message;
					errorDiv.style.display = "block";
				}
			}

			function showSuccess(message) {
				const successDiv = document.getElementById("successMessage");
				if (successDiv) {
					successDiv.textContent = message;
					successDiv.style.display = "block";
				}
			}

			function hideError() {
				const errorDiv = document.getElementById("errorMessage");
				const successDiv = document.getElementById("successMessage");
				if (errorDiv) errorDiv.style.display = "none";
				if (successDiv) successDiv.style.display = "none";
			}

			function skipSetup() {
				isFirebaseConnected = false;
				checkAuthStatus();
			}

			window.logout = function () {
				if (unsubscribe) {
					unsubscribe();
					unsubscribe = null;
				}
				currentUser = null;
				delete window.sessionUser;
				document.getElementById("username").value = "";
				document.getElementById("password").value = "";
				hideError();
				showLogin();
			};

			window.addTask = function () {
				if (!hasPermission("create_task")) {
					alert("You do not have permission to create tasks");
					return;
				}

				const taskInput = document.getElementById("taskInput");
				const taskText = taskInput.value.trim();

				if (taskText === "") {
					alert("Please enter a task description");
					return;
				}

				const task = {
					id: taskIdCounter++,
					text: taskText,
					status: "todo",
					createdAt: new Date().toISOString(),
					createdBy: currentUser,
					completedAt: null,
					completedBy: null,
					approvedAt: null,
					approvedBy: null,
				};

				if (isFirebaseConnected && db) {
					db.collection("tasks")
						.doc(task.id.toString())
						.set(task)
						.then(() => {
							return db
								.collection("metadata")
								.doc("counter")
								.set({
									taskIdCounter: taskIdCounter,
								});
						})
						.catch((error) => {
							console.error("Error adding task:", error);
							alert("Failed to add task. Please try again.");
							taskIdCounter--; // Revert counter on error
						});
				} else {
					tasks.push(task);
					saveTasks();
					renderTasks();
					updateStats();
				}

				taskInput.value = "";
			};

			window.checkOffTask = function (taskId) {
				if (!hasPermission("check_task")) {
					alert("You do not have permission to check off tasks");
					return;
				}

				const updates = {
					status: "pending_approval",
					completedAt: new Date().toISOString(),
					completedBy: currentUser,
				};

				if (isFirebaseConnected && db) {
					db.collection("tasks")
						.doc(taskId.toString())
						.update(updates)
						.catch((error) => {
							console.error("Error updating task:", error);
							alert("Failed to update task. Please try again.");
						});
				} else {
					const task = tasks.find((t) => t.id === taskId);
					if (task && task.status === "todo") {
						Object.assign(task, updates);
						saveTasks();
						renderTasks();
						updateStats();
					}
				}
			};

			window.approveTask = function (taskId) {
				if (!hasPermission("approve_task")) {
					alert("You do not have permission to approve tasks");
					return;
				}

				const updates = {
					status: "completed",
					approvedAt: new Date().toISOString(),
					approvedBy: currentUser,
				};

				if (isFirebaseConnected && db) {
					db.collection("tasks")
						.doc(taskId.toString())
						.update(updates)
						.catch((error) => {
							console.error("Error approving task:", error);
							alert("Failed to approve task. Please try again.");
						});
				} else {
					const task = tasks.find((t) => t.id === taskId);
					if (task && task.status === "pending_approval") {
						Object.assign(task, updates);
						saveTasks();
						renderTasks();
						updateStats();
					}
				}
			};

			window.deleteTask = function (taskId) {
				if (!hasPermission("delete_task")) {
					alert("You do not have permission to delete tasks");
					return;
				}

				if (!confirm("Are you sure you want to delete this task?")) {
					return;
				}

				if (isFirebaseConnected && db) {
					db.collection("tasks")
						.doc(taskId.toString())
						.delete()
						.catch((error) => {
							console.error("Error deleting task:", error);
							alert("Failed to delete task. Please try again.");
						});
				} else {
					tasks = tasks.filter((t) => t.id !== taskId);
					saveTasks();
					renderTasks();
					updateStats();
				}
			};

			function loadTasks() {
				if (isFirebaseConnected && db) {
					// Set up real-time listener
					if (unsubscribe) {
						unsubscribe();
					}

					unsubscribe = db
						.collection("tasks")
						.onSnapshot((snapshot) => {
							tasks = [];
							snapshot.forEach((doc) => {
								tasks.push({
									id: parseInt(doc.id),
									...doc.data(),
								});
							});
							tasks.sort(
								(a, b) =>
									new Date(b.createdAt) -
									new Date(a.createdAt)
							);
							renderTasks();
							updateStats();
						});

					// Load counter
					db.collection("metadata")
						.doc("counter")
						.get()
						.then((doc) => {
							if (doc.exists) {
								taskIdCounter = doc.data().taskIdCounter || 1;
							}
						});
				} else {
					// Load from local storage
					if (window.tasksData) {
						tasks = window.tasksData.tasks || [];
						taskIdCounter = window.tasksData.taskIdCounter || 1;
					}
					renderTasks();
					updateStats();
				}
			}

			function renderTasks() {
				const user = users[currentUser];

				if (user.role === "creator") {
					renderCreatorView();
				} else if (user.role === "checker") {
					renderCheckerView();
				}
			}

			function renderCreatorView() {
				// Pending tasks
				const pendingTasks = tasks.filter(
					(t) => t.status === "pending_approval"
				);
				const pendingContainer =
					document.getElementById("pendingTasks");

				if (pendingTasks.length === 0) {
					pendingContainer.innerHTML =
						'<div class="empty-state">No tasks pending approval</div>';
				} else {
					pendingContainer.innerHTML = pendingTasks
						.map(
							(task) => `
                    <div class="task-item pending-approval">
                        <div class="task-content">
                            <div>
                                <span class="status-badge status-pending">Pending Approval</span>
                                <span class="task-text">${escapeHtml(
									task.text
								)}</span>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                    Completed by: ${
										users[task.completedBy]?.displayName ||
										task.completedBy
									}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="action-btn approve-btn" onclick="approveTask(${
									task.id
								})">Approve</button>
                                <button class="action-btn delete-btn" onclick="deleteTask(${
									task.id
								})">Delete</button>
                            </div>
                        </div>
                    </div>
                `
						)
						.join("");
				}

				// All tasks
				const allTasksContainer =
					document.getElementById("allTasksCreator");

				if (tasks.length === 0) {
					allTasksContainer.innerHTML =
						'<div class="empty-state">No tasks created yet</div>';
				} else {
					allTasksContainer.innerHTML = tasks
						.map(
							(task) => `
                    <div class="task-item ${
						task.status === "completed" ? "completed" : ""
					}">
                        <div class="task-content">
                            <div>
                                <span class="status-badge ${
									task.status === "completed"
										? "status-completed"
										: "status-pending"
								}">
                                    ${
										task.status === "completed"
											? "Completed"
											: task.status === "pending_approval"
											? "Pending"
											: "To Do"
									}
                                </span>
                                <span class="task-text">${escapeHtml(
									task.text
								)}</span>
                                ${
									task.completedBy
										? `<div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                    Completed by: ${
										users[task.completedBy]?.displayName ||
										task.completedBy
									}
                                </div>`
										: ""
								}
                            </div>
                            <div class="task-actions">
                                <button class="action-btn delete-btn" onclick="deleteTask(${
									task.id
								})">Delete</button>
                            </div>
                        </div>
                    </div>
                `
						)
						.join("");
				}
			}

			function renderCheckerView() {
				// Tasks to check
				const todoTasks = tasks.filter((t) => t.status === "todo");
				const tasksToCheckContainer =
					document.getElementById("tasksToCheck");

				if (todoTasks.length === 0) {
					tasksToCheckContainer.innerHTML =
						'<div class="empty-state">No tasks to complete</div>';
				} else {
					tasksToCheckContainer.innerHTML = todoTasks
						.map(
							(task) => `
                    <div class="task-item">
                        <div class="task-content">
                            <div>
                                <span class="task-text">${escapeHtml(
									task.text
								)}</span>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                    Created by: ${
										users[task.createdBy]?.displayName ||
										task.createdBy
									}
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="action-btn check-btn" onclick="checkOffTask(${
									task.id
								})">Mark Complete</button>
                            </div>
                        </div>
                    </div>
                `
						)
						.join("");
				}

				// Completed tasks (only ones completed by this user)
				const myCompletedTasks = tasks.filter(
					(t) =>
						(t.status === "pending_approval" ||
							t.status === "completed") &&
						t.completedBy === currentUser
				);
				const completedContainer =
					document.getElementById("completedTasks");

				if (myCompletedTasks.length === 0) {
					completedContainer.innerHTML =
						'<div class="empty-state">No completed tasks</div>';
				} else {
					completedContainer.innerHTML = myCompletedTasks
						.map(
							(task) => `
                    <div class="task-item ${
						task.status === "completed"
							? "completed"
							: "pending-approval"
					}">
                        <div class="task-content">
                            <div>
                                <span class="status-badge ${
									task.status === "completed"
										? "status-completed"
										: "status-pending"
								}">
                                    ${
										task.status === "completed"
											? "Approved"
											: "Pending Approval"
									}
                                </span>
                                <span class="task-text">${escapeHtml(
									task.text
								)}</span>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                    Created by: ${
										users[task.createdBy]?.displayName ||
										task.createdBy
									}
                                </div>
                            </div>
                        </div>
                    </div>
                `
						)
						.join("");
				}
			}

			function updateStats() {
				const total = tasks.length;
				const pending = tasks.filter(
					(t) =>
						t.status === "todo" || t.status === "pending_approval"
				).length;
				const completed = tasks.filter(
					(t) => t.status === "completed"
				).length;

				document.getElementById("totalTasks").textContent = total;
				document.getElementById("pendingCount").textContent = pending;
				document.getElementById("completedCount").textContent =
					completed;
			}

			function saveTasks() {
				// Store in memory for local mode
				window.tasksData = {
					tasks: tasks,
					taskIdCounter: taskIdCounter,
				};
			}

			function escapeHtml(text) {
				const div = document.createElement("div");
				div.textContent = text;
				return div.innerHTML;
			}
		</script>
	</body>
</html>
